# 車中泊スポット自動紹介ページ生成システム - 要件定義

## 📋 プロジェクト概要

各地域のお祭り・イベントに特化した車中泊スポット紹介ページを自動生成するシステム。
Supabaseのデータベースからデータを取得し、WordPress形式のHTMLページと地図を自動生成する。

---

## ✅ 現在実装されている機能

### 1. データ取得機能
- **Supabaseデータベース連携**
  - `parking_spots`: 駐車場データ（料金、位置、営業時間）
  - `convenience_stores`: コンビニデータ
  - `toilets`: トイレ施設データ
  - `hot_springs`: 温泉施設データ
  - `festivals`: お祭り・イベントデータ
  - レストランデータ（Tabelog由来）

### 2. 駐車場評価・ランキング機能
- **料金計算**
  - 18:00〜8:00（14時間）の車中泊料金を自動計算
  - 最大料金、夜間料金、通常料金から最適な料金を算出

- **距離計算**
  - イベント会場からの距離計算（geolib使用）
  - 徒歩時間計算（80m/分で換算）

- **周辺施設検索**
  - コンビニ（300m以内）
  - トイレ（300m以内）
  - 温泉（2km以内）
  - レストラン（300m以内、評価3.5以上）

- **ソート・フィルタリング**
  - イベント会場から1km以内の駐車場に絞り込み
  - 料金が安い順→距離が近い順でソート
  - 上位10件を抽出

### 3. HTML生成機能（WordPress用）
- **イベント情報セクション**
  - イベント名、開催時期、説明
  - Google Maps/検索リンク

- **インタラクティブ地図＋駐車場リスト**
  - 左70%: 埋め込み地図（iframe）
  - 右30%: クリック可能な駐車場リスト
  - クリックで地図のマーカーを表示する機能
  - レスポンシブデザイン対応

- **駐車場詳細表示**
  - 料金（18:00〜8:00）
  - 徒歩時間
  - 周辺施設（コンビニロゴ付き、トイレ、温泉）
  - Google Maps/検索リンク

- **スタイリング**
  - WordPressブロックエディタ形式
  - カスタムCSS（レスポンシブ対応）
  - カラーテーマ統一

### 4. 地図生成機能
- **マーカー配置**
  - 🔴 イベント会場（赤）
  - 🔵 駐車場（青）
  - 🏪 コンビニ
  - 🚻 トイレ
  - ♨️ 温泉

- **インタラクション**
  - マーカークリックでポップアップ表示
  - JavaScript経由で外部からマーカーを強調表示する機能

### 5. note.com自動投稿機能（既存）
- AI評価による車中泊スポット選定
- Wikimedia Commonsからの画像取得
- 記事の自動生成と投稿
- 投稿履歴管理

### 6. 実装済みの具体例
- **小樽雪あかりの路**
  - `update-otaru-data.js`: データ取得
  - `generate-otaru-html.js`: WordPress HTML生成
  - `generate-otaru-map.js`: 地図HTML生成（推測）

---

## 🚀 今後実装すべき機能

### 高優先度（必須機能）

#### 1. マルチイベント対応の自動化
**現状**: 小樽雪あかりの路専用にハードコーディング
**目標**: 任意のイベントに対応できる汎用システム

**実装内容**:
- [ ] イベントマスターデータ管理
  - `festivals`テーブルから自動取得
  - イベント名、開催日、中心座標、説明文

- [ ] 動的ファイル生成
  - `update-{event-slug}-data.js` → `update-event-data.js --event=otaru`
  - イベントスラッグ/IDをパラメータ化

- [ ] テンプレートエンジン導入
  - HTMLテンプレート（Handlebars/EJS）
  - イベント情報を差し込み

#### 2. バッチ処理・一括生成機能
**目標**: 全イベントのページを一括生成

**実装内容**:
- [ ] `generate-all-events.js` スクリプト
  - Supabaseから全イベントを取得
  - 各イベントごとにデータ取得→HTML生成→地図生成

- [ ] 進捗表示
  - コンソールログで処理状況表示
  - エラー時は次のイベントに継続

- [ ] 出力ディレクトリ構造
  ```
  output/
    ├── otaru-yukiakari/
    │   ├── index.html
    │   ├── map.html
    │   └── data.json
    ├── sapporo-snow-festival/
    │   ├── index.html
    │   ├── map.html
    │   └── data.json
  ```

#### 3. WordPress API連携（自動投稿）
**目標**: 生成したHTMLをWordPressに直接投稿

**実装内容**:
- [ ] WordPress REST API認証
  - Application Passwordsの設定

- [ ] 記事自動投稿
  - タイトル、本文、カテゴリ、タグ
  - アイキャッチ画像の自動設定

- [ ] 更新管理
  - 既存記事の検出（イベントIDで紐付け）
  - 新規作成 vs 更新の判定
  - 投稿ステータス（下書き/公開）の制御

#### 4. 地図の改善
**目標**: より使いやすいインタラクティブ地図

**実装内容**:
- [ ] Leaflet.js/Mapbox GL JS導入
  - Google Maps依存を減らす（API費用削減）
  - カスタマイズ性向上

- [ ] クラスタリング
  - 駐車場が多い場合にマーカーをグループ化

- [ ] ルート案内
  - 現在地から駐車場へのルート表示
  - 徒歩/車の切り替え

- [ ] フィルタリング機能
  - 料金レンジ（無料/500円以下/1000円以下）
  - 周辺施設（コンビニあり/温泉あり）

#### 5. データ更新の自動化
**目標**: 定期的にデータを再取得・再生成

**実装内容**:
- [ ] cron/GitHub Actions設定
  - 毎日/毎週自動実行

- [ ] 差分検出
  - 前回生成時から変更があった場合のみ更新
  - 新規イベント追加時に自動生成

---

### 中優先度（UX向上）

#### 6. レストラン情報の充実
**実装内容**:
- [ ] レストランセクションの追加
  - 評価順トップ10を表示
  - 予算、ジャンル、営業時間

- [ ] 地図へのレストランマーカー追加
  - 🍴アイコンで表示

- [ ] Tabelog評価の表示
  - スコア、レビュー数、ジャンル

#### 7. 画像の自動取得・最適化
**実装内容**:
- [ ] イベント画像取得
  - Wikimedia Commons/Unsplash API
  - 著作権フリー画像のみ

- [ ] 駐車場画像取得
  - Google Places API（Street View）

- [ ] 画像の最適化
  - WebP変換
  - レスポンシブ画像生成

#### 8. SEO最適化
**実装内容**:
- [ ] メタタグ生成
  - title, description, OGP

- [ ] 構造化データ（JSON-LD）
  - Event, ParkingFacility

- [ ] サイトマップ生成
  - 全イベントページのURL

#### 9. ユーザーレビュー・評価機能
**実装内容**:
- [ ] 駐車場の口コミ投稿
  - Supabaseに保存

- [ ] 評価スコア
  - ユーザー評価平均を表示

- [ ] おすすめポイント
  - 実際に車中泊した人のコメント

---

### 低優先度（将来的な拡張）

#### 10. 多言語対応
- [ ] 英語/中国語/韓国語ページ生成
- [ ] 翻訳API連携（DeepL/Google Translate）

#### 11. モバイルアプリ対応
- [ ] JSON API提供
- [ ] React Native/Flutter用のエンドポイント

#### 12. リアルタイム混雑状況
- [ ] 駐車場の空き状況API連携
- [ ] ユーザー投稿による混雑情報

#### 13. 料金予測
- [ ] 過去データから料金変動を予測
- [ ] イベント期間中の特別料金を自動検出

#### 14. ルート最適化
- [ ] 複数駐車場の巡回ルート提案
- [ ] 周辺観光スポットを含めた周遊プラン

---

## 🎯 推奨実装順序

### フェーズ1: 汎用化（1-2週間）
1. イベントマスターデータ管理
2. テンプレートエンジン導入
3. 動的ファイル生成

### フェーズ2: 自動化（1-2週間）
4. バッチ処理・一括生成
5. WordPress API連携
6. データ更新の自動化

### フェーズ3: 機能拡張（2-3週間）
7. 地図の改善
8. レストラン情報の充実
9. 画像の自動取得・最適化

### フェーズ4: 品質向上（1-2週間）
10. SEO最適化
11. ユーザーレビュー機能
12. テスト・デバッグ

---

## 📊 技術スタック

### 現在
- Node.js
- Supabase (PostgreSQL + PostGIS)
- geolib (距離計算)
- WordPress (手動投稿)

### 追加推奨
- **テンプレート**: Handlebars / EJS
- **地図**: Leaflet.js / Mapbox GL JS
- **WordPress連携**: @wordpress/api-fetch
- **画像処理**: sharp (既に導入済み)
- **スケジューラ**: node-cron (既に導入済み)
- **テスト**: Jest
- **CI/CD**: GitHub Actions

---

## 📈 成功指標（KPI）

- **自動化率**: 手動作業0%を目指す
- **生成時間**: 1イベントあたり5秒以内
- **データ精度**: 駐車場情報の正確性95%以上
- **SEO**: 検索順位トップ10入り
- **ユーザー満足度**: レビュー評価4.0以上

---

## 🔐 セキュリティ・運用考慮事項

- [ ] API keyの環境変数管理（.env）
- [ ] レート制限対策（Supabase/WordPress）
- [ ] エラーハンドリング・リトライ処理
- [ ] ログ管理（成功/失敗/処理時間）
- [ ] バックアップ（生成済みファイルの保存）
- [ ] アクセス制限（WordPress管理画面）

---

## 📚 参考資料・ドキュメント

- Supabase Docs: https://supabase.com/docs
- WordPress REST API: https://developer.wordpress.org/rest-api/
- Leaflet.js: https://leafletjs.com/
- Geolib: https://github.com/manuelbieh/geolib
