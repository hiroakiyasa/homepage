const fs = require('fs');
const path = require('path');

// ã‚«ãƒ©ãƒ¼è¡¨ç¤ºç”¨
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  red: '\x1b[31m'
};

/**
 * HTMLãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„JSONé …ç›®ã‚’å‰Šé™¤
 */
async function cleanupJSONWithoutHTML() {
  console.log(`${colors.blue}=== HTMLãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„JSONé …ç›®ã‚’å‰Šé™¤ ===${colors.reset}\n`);

  // JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
  const jsonPath = path.join(__dirname, 'data', 'regions-data-with-elevation.json');
  const regions = JSON.parse(fs.readFileSync(jsonPath, 'utf8'));
  console.log(`ğŸ“ ${regions.length}ç®‡æ‰€ã®åœ°åŸŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ\n`);

  // regionsãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹
  const regionsDir = path.join(__dirname, 'data', 'regions');

  // HTMLãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹åœ°åŸŸã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const regionsWithHTML = [];
  const regionsWithoutHTML = [];

  for (const region of regions) {
    const fileName = (region.fileName || region.name).replace(/[\/\\:*?"<>|]/g, '_');
    const htmlPath = path.join(regionsDir, `${fileName}.html`);

    if (fs.existsSync(htmlPath)) {
      regionsWithHTML.push(region);
    } else {
      regionsWithoutHTML.push({ name: region.name, fileName });
    }
  }

  console.log(`${colors.green}âœ… HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚ã‚Š: ${regionsWithHTML.length}ç®‡æ‰€${colors.reset}`);
  console.log(`${colors.red}âŒ HTMLãƒ•ã‚¡ã‚¤ãƒ«ãªã—: ${regionsWithoutHTML.length}ç®‡æ‰€${colors.reset}\n`);

  if (regionsWithoutHTML.length > 0) {
    console.log(`${colors.yellow}=== HTMLãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„åœ°åŸŸ ===${colors.reset}`);
    regionsWithoutHTML.slice(0, 20).forEach(r => {
      console.log(`  - ${r.name} (${r.fileName})`);
    });
    if (regionsWithoutHTML.length > 20) {
      console.log(`  ... and ${regionsWithoutHTML.length - 20} more`);
    }
    console.log();

    // æ›´æ–°ã•ã‚ŒãŸJSONã‚’ä¿å­˜
    fs.writeFileSync(jsonPath, JSON.stringify(regionsWithHTML, null, 2), 'utf8');
    console.log(`${colors.green}âœ… JSONãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°: ${jsonPath}${colors.reset}`);
    console.log(`${colors.blue}ğŸ“ æ›´æ–°å¾Œã®åœ°åŸŸæ•°: ${regionsWithHTML.length}ç®‡æ‰€${colors.reset}\n`);
  }

  return regionsWithHTML;
}

// å®Ÿè¡Œ
cleanupJSONWithoutHTML().catch(err => {
  console.error('ã‚¨ãƒ©ãƒ¼:', err);
  process.exit(1);
});
