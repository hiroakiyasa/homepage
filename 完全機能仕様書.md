# 車旅コンシェルジュ（CAR Concierge）完全機能仕様書

## 目次
1. [アプリケーション概要](#1-アプリケーション概要)
2. [技術スタック](#2-技術スタック)
3. [アーキテクチャ](#3-アーキテクチャ)
4. [データ構造](#4-データ構造)
5. [画面一覧と詳細機能](#5-画面一覧と詳細機能)
6. [サービス層](#6-サービス層)
7. [状態管理](#7-状態管理)
8. [データベース設計](#8-データベース設計)
9. [UI/UXパターン](#9-uiuxパターン)
10. [駐車料金計算アルゴリズム](#10-駐車料金計算アルゴリズム)
11. [位置情報機能](#11-位置情報機能)
12. [認証・ユーザー管理](#12-認証ユーザー管理)
13. [ユーザー投稿機能（クラウドソーシング）](#13-ユーザー投稿機能クラウドソーシング)
14. [環境変数と設定](#14-環境変数と設定)
15. [ビルドとデプロイ](#15-ビルドとデプロイ)

---

## 1. アプリケーション概要

### 1.1 アプリ名
**車旅コンシェルジュ（CAR Concierge）**

### 1.2 目的
日本国内での車旅をサポートするモバイルアプリケーション。駐車場、コンビニ、温泉、ガソリンスタンド、お祭りなどの情報を地図上で表示し、最適なスポットを見つけるための機能を提供する。

### 1.3 主要機能
1. **地図表示機能**：インタラクティブな地図上に各種施設を表示
2. **駐車場料金計算**：複雑な料金体系（基本料金、累進料金、最大料金、時間帯別料金、24時間超の表記対応）に対応
3. **ランキング表示**：駐車料金が安い順に上位20件を表示
4. **フィルタリング機能**：カテゴリ、標高、周辺施設、駐車場タイプでフィルタ
5. **周辺施設検索**：コンビニ・温泉・トイレへの距離を表示
6. **レビュー機能**：駐車場と温泉のレビュー投稿・閲覧
7. **お気に入り機能**：駐車場をお気に入りに追加
8. **ユーザー投稿機能**：駐車場の看板写真をOCRで自動解析して投稿
9. **認証機能**：メール/パスワード、Google OAuth

### 1.4 対応プラットフォーム
- iOS（メイン）
- Android（対応）
- Web（限定的対応）

### 1.5 バンドル識別子
- iOS: `com.carconciege.app`
- Android: `com.carconciege.app`

---

## 2. 技術スタック

### 2.1 フロントエンド
- **React Native**: 0.74.5
- **Expo SDK**: 54
- **TypeScript**: 5.3.3（strict mode有効）
- **React Navigation**: @react-navigation/native ^6.1.18
- **React Query**: @tanstack/react-query ^5.56.2

### 2.2 状態管理
- **Zustand**: ^4.5.5（グローバル状態管理）

### 2.3 バックエンド
- **Supabase**: PostgreSQL + Realtime + Storage + Edge Functions
  - データベース: PostgreSQL 15+
  - 認証: Supabase Auth（メール/パスワード、Google OAuth）
  - ストレージ: Supabase Storage（画像アップロード）
  - Edge Functions: Deno runtime（OCR処理）

### 2.4 地図
- **react-native-maps**: ^1.18.0（iOS: Apple Maps、Android: Google Maps）
- **react-leaflet**: ^4.2.1（Web用）

### 2.5 その他主要ライブラリ
- **expo-location**: GPS位置情報取得
- **expo-image-picker**: カメラ・ギャラリーアクセス
- **react-native-gesture-handler**: ジェスチャー処理
- **@gorhom/bottom-sheet**: ボトムシート UI

### 2.6 外部API
- **Gemini 2.5 Flash API**: 駐車場看板のOCR + 料金正規化
- **Google Cloud Vision API**: 画像テキスト抽出（オプション）

---

## 3. アーキテクチャ

### 3.1 アプリケーションアーキテクチャ

```
┌─────────────────────────────────────────────┐
│           React Navigation Stack            │
├─────────────────────────────────────────────┤
│  MapScreen (メイン画面)                      │
│  ├── CompactBottomPanel (フィルタ)          │
│  ├── CategoryButtons (カテゴリ選択)         │
│  ├── CustomMarker (マーカー)                │
│  ├── RankingListModal (ランキング)         │
│  └── SpotDetailBottomSheet (詳細)          │
├─────────────────────────────────────────────┤
│  その他の画面                                │
│  ├── 認証画面 (Login, SignUp, etc.)         │
│  ├── プロフィール画面                        │
│  ├── お気に入り画面                          │
│  ├── レビュー一覧画面                        │
│  ├── 駐車場投稿画面 (AddParkingScreen)      │
│  └── 投稿管理画面 (AdminSubmissionsScreen)  │
└─────────────────────────────────────────────┘
          ↓ データフロー
┌─────────────────────────────────────────────┐
│          Zustand Stores                     │
│  ├── useMainStore (検索、地図、UI状態)      │
│  └── useAuthStore (認証状態)                │
└─────────────────────────────────────────────┘
          ↓ サービス層
┌─────────────────────────────────────────────┐
│          Services Layer                     │
│  ├── SupabaseService (データ取得)           │
│  ├── SearchService (検索・フィルタ)         │
│  ├── ParkingFeeCalculator (料金計算)        │
│  ├── LocationService (GPS)                  │
│  ├── AuthService (認証)                     │
│  ├── ReviewService (レビュー)               │
│  └── FavoritesService (お気に入り)          │
└─────────────────────────────────────────────┘
          ↓ バックエンド
┌─────────────────────────────────────────────┐
│          Supabase Backend                   │
│  ├── PostgreSQL Database                    │
│  │   ├── parking_spots                      │
│  │   ├── convenience_stores                 │
│  │   ├── hot_springs                        │
│  │   ├── gas_stations                       │
│  │   ├── festivals                          │
│  │   ├── parking_reviews                    │
│  │   ├── parking_submissions (投稿)         │
│  │   └── user_profiles                      │
│  ├── Supabase Auth                          │
│  ├── Storage (parking-submissions bucket)   │
│  └── Edge Functions                         │
│      └── process-parking-image (OCR)        │
└─────────────────────────────────────────────┘
```

### 3.2 データフロー
1. **ユーザー操作** → MapScreen
2. **検索リクエスト** → SearchService → SupabaseService
3. **データ取得** → Supabase PostgreSQL
4. **料金計算** → ParkingFeeCalculator (クライアント側)
5. **状態更新** → useMainStore (Zustand)
6. **UI更新** → React コンポーネント

### 3.3 パス別名設定
```typescript
"@/": "src/"
"@components/": "src/components/"
"@screens/": "src/screens/"
"@services/": "src/services/"
"@stores/": "src/stores/"
"@types/": "src/types/"
"@utils/": "src/utils/"
"@config/": "src/config/"
"@assets/": "src/assets/"
```

---

## 4. データ構造

### 4.1 Spot（基本スポット）
```typescript
interface Spot {
  id: string;
  name: string;
  lat: number;
  lng: number;
  category: string;
  type?: string;
  description?: string;
  address?: string;
  rating?: number;
  quietness?: number;
  rank?: number;
  prefecture?: string;
  elevation?: number;
}
```

### 4.2 CoinParking（駐車場）
```typescript
interface CoinParking extends Spot {
  originalFees?: string;
  rates: ParkingRate[];  // 料金配列
  hours?: HoursInfo;     // 営業時間
  capacity?: number;
  paymentMethods?: string;
  restrictions?: string;
  vehicleDimensions?: VehicleDimensions;
  calculatedFee?: number;  // 計算済み料金
  nearestConvenienceStore?: NearbyFacility;
  nearestHotspring?: NearbyFacility;
  nearest_toilet?: NearbyFacility;
  isOpenDuringParking?: boolean;
  operatingStatus?: string;
  parkingType?: string;  // 平面駐車場、立体駐車場、機械式、車中泊・キャンプ場
}
```

### 4.3 ParkingRate（料金構造）
```typescript
interface ParkingRate {
  id: string;
  type: string;        // "base", "progressive", "max"
  minutes: number;     // 時間単位（分）
  price: number;       // 料金（円）
  timeRange?: string;  // 時間帯 "8:00～20:00", "25:30～5:30"（24時間超対応）
  dayType?: string;
  applyAfter?: number; // 累進料金の適用開始時間（分）
}
```

### 4.4 HoursInfo（営業時間）
```typescript
interface HoursInfo {
  hours?: string;
  is_24h?: boolean;
  holidays?: string[];
  schedules?: Schedule[];
  access_24h?: boolean;
  closed_days?: string[];
  restrictions?: string[];
  operating_days?: string[];
  original_hours?: string;
}
```

### 4.5 NearbyFacility（周辺施設）
```typescript
interface NearbyFacility {
  id: string;
  name?: string;
  distance?: number;
  distance_m?: number;
}
```

### 4.6 ConvenienceStore（コンビニ）
```typescript
interface ConvenienceStore extends Spot {
  idString: string;
  brand?: string;  // "Seven-Eleven", "Lawson", "FamilyMart"等
  subType?: string;
  phoneNumber?: string;
  operatingHours?: string;
}
```

### 4.7 HotSpring（温泉）
```typescript
interface HotSpring extends Spot {
  price?: string;
  operatingHours?: string;
  holidayInfo?: string;
  facilityType?: string;
}
```

### 4.8 GasStation（ガソリンスタンド）
```typescript
interface GasStation extends Spot {
  brand?: string;
  services?: {
    regular_price?: number;
    premium_price?: number;
    diesel_price?: number;
    last_updated?: string;
  };
  operatingHours?: string;
}
```

### 4.9 Festival（お祭り）
```typescript
interface Festival extends Spot {
  eventDate?: string;
  eventType?: string;
}
```

### 4.10 SearchFilter（検索フィルタ）
```typescript
interface SearchFilter {
  selectedCategories: Set<string>;
  searchRadius: number;
  minElevation: number;
  parkingTimeFilterEnabled: boolean;
  radiusFilterEnabled: boolean;
  elevationFilterEnabled: boolean;
  nearbyCategories: Set<string>;
  convenienceStoreRadius: number;
  toiletRadius: number;
  hotSpringRadius: number;
  showFlatParking: boolean;         // 平面駐車場
  showMultiStoryParking: boolean;   // 立体駐車場
  showMechanicalParking: boolean;   // 機械式駐車場
  parkingDuration: ParkingDuration;
  nearbyFilterEnabled?: boolean;
  nearbyRadius?: number;
  nearbyCategory?: 'convenience' | 'hotspring';
}
```

### 4.11 Region（地図範囲）
```typescript
interface Region {
  latitude: number;
  longitude: number;
  latitudeDelta: number;
  longitudeDelta: number;
}
```

### 4.12 カテゴリ定数
```typescript
const CATEGORIES = {
  PARKING: 'コインパーキング',
  CONVENIENCE: 'コンビニ',
  HOT_SPRING: '温泉',
  FESTIVAL: 'お祭り・花火大会',
  GAS_STATION: 'ガソリンスタンド',
} as const;

const CATEGORY_EMOJIS = {
  'コインパーキング': '🅿️',
  'コンビニ': '🏪',
  '温泉': '♨️',
  'お祭り・花火大会': '🎆',
  'ガソリンスタンド': '⛽',
};
```

---

## 5. 画面一覧と詳細機能

### 5.1 メイン画面

#### MapScreen（地図画面）
**役割**: アプリのメイン画面。地図上に施設を表示し、検索・フィルタ・ランキング表示を行う。

**主要機能**:
1. **地図表示**
   - iOS: Apple Maps
   - Android: Google Maps
   - Web: Leaflet (OpenStreetMap)
   - 初回起動時: 前回閉じた位置を表示 → 現在地取得後に移動
   - GPS位置取得失敗時: 前回の位置を継続使用
   - 保存位置もない場合のみ: 東京駅をデフォルト表示

2. **マーカー表示**
   - 駐車場: 料金ランキング1位～3位は金・銀・銅のメダルマーカー
   - 駐車場: 4位以降は青い番号マーカー（料金順位）
   - コンビニ: 🏪 アイコン
   - 温泉: ♨️ アイコン
   - お祭り: 🎆 アイコン
   - ガソリンスタンド: ⛽ アイコン
   - 現在地: 青い円マーカー
   - 選択中のマーカー: 1.3倍にスケール + 赤枠

3. **マーカータップ動作**
   - 1回目タップ: コールアウト表示（名前と簡単な情報）
   - 2回目タップ: 詳細ボトムシート表示

4. **パフォーマンス最適化**
   - 駐車場は料金順に上位20件のみ表示
   - 300件を超える場合: 警告アラート表示
   - マーカーは `tracksViewChanges={false}` で最適化

5. **リアルタイム位置追跡**
   - 現在地ボタン（右下の青いボタン）タップでON/OFF
   - 2秒ごと or 10m移動ごとに更新
   - 高精度GPS使用

6. **検索エリア調整**
   - UI要素（上部・下部パネル）を考慮した検索範囲
   - ボトムシート表示時は上部50%のみを検索範囲に

**サブコンポーネント**:
- `CategoryButtons`: カテゴリ選択ボタン（駐車場、コンビニ、温泉等）
- `CompactBottomPanel`: フィルタコントロール
- `RankingListModal`: ランキングモーダル
- `SpotDetailBottomSheet`: 詳細ボトムシート
- `MapScale`: 縮尺バー

**状態管理**:
```typescript
// ローカル状態
const [mapRegion, setMapRegion] = useState<Region>();
const [isMapReady, setIsMapReady] = useState(false);
const [showRankingModal, setShowRankingModal] = useState(false);
const [showDetailSheet, setShowDetailSheet] = useState(false);
const [isLocationTracking, setIsLocationTracking] = useState(false);
const [locationStatus, setLocationStatus] = useState<'loading' | 'success' | 'error' | 'denied'>('loading');
const [toastMessage, setToastMessage] = useState<string | null>(null);
const [isInitializingMap, setIsInitializingMap] = useState(true);

// グローバル状態 (Zustand)
const {
  searchResults,
  selectedSpot,
  searchFilter,
  setSearchResults,
  selectSpot,
} = useMainStore();
```

**ファイルパス**: `src/screens/MapScreen.tsx` (2,700行+)

---

#### CompactBottomPanel（フィルタパネル）
**役割**: 地図下部の検索・フィルタコントロール

**主要機能**:
1. **フィルタモード切り替え**
   - 駐車料金フィルタ（デフォルト）
   - 周辺検索フィルタ（コンビニ・温泉・トイレ）
   - 標高フィルタ（0～2000m、対数スケール）

2. **駐車料金フィルタ**
   - 入庫日時選択
   - 出庫日時選択
   - 駐車時間表示（自動計算）
   - 駐車場タイプ選択（平面、立体、機械式）

3. **周辺検索フィルタ**
   - コンビニまでの距離（0～1000m）
   - 温泉までの距離（0～10km）
   - トイレまでの距離（0～1000m）
   - OR検索: いずれかの施設が範囲内にあれば表示

4. **標高フィルタ**
   - スライダーで最低標高を設定
   - 温度計算: -0.6°C/100m
   - 津波マーカー: 30m地点

**ファイルパス**: `src/components/CompactBottomPanel.tsx`

---

#### CategoryButtons（カテゴリボタン）
**役割**: 施設カテゴリの選択

**表示カテゴリ**:
- 🅿️ 駐車場（デフォルト選択）
- 🏪 コンビニ
- 🍴 トイレ
- ⛽ 温泉

**動作**:
- 複数選択可能
- 選択時は青背景、未選択時は白背景
- 選択変更時に自動で地図を再検索

**ファイルパス**: `src/components/CategoryButtons.tsx`

---

#### RankingListModal（ランキングモーダル）
**役割**: 駐車料金が安い順に上位20件をリスト表示

**主要機能**:
1. **リスト表示**
   - 1位～3位: 金・銀・銅のメダル表示
   - 4位～20位: 順位番号
   - 駐車場名、住所、料金を表示

2. **タップ動作**
   - 1回目タップ: 地図中央にマーカーを移動
   - 2回目タップ: 詳細ボトムシート表示（モーダルを閉じてから表示）

3. **モーダルスタック制限対応**
   - React Nativeの制限で複数モーダルを重ねられない
   - ランキングモーダルを閉じてから詳細シートを開く
   - `setTimeout`で滑らかな遷移

**表示高さ**: 画面の50%

**ファイルパス**: `src/screens/RankingListModal.tsx`

---

#### SpotDetailBottomSheet（詳細ボトムシート）
**役割**: 施設の詳細情報を表示

**表示内容（駐車場）**:
1. **基本情報**
   - 駐車場名
   - 住所
   - 料金表示（計算済み料金）
   - 駐車場タイプ（平面、立体、機械式、車中泊・キャンプ場）
   - 営業時間

2. **料金詳細**
   - 料金構造（基本料金、累進料金、最大料金）
   - 時間帯別料金
   - フォーマット例: "30分未満無料、30分以降入庫から30分毎¥250"

3. **周辺施設情報**
   - 最寄りのコンビニ（距離、ブランド）
   - 最寄りの温泉（距離）
   - 最寄りのトイレ（距離）

4. **アクション**
   - Google Mapsで開く
   - お気に入りに追加/削除（要ログイン）
   - レビューを見る
   - レビューを投稿（要ログイン）

**表示内容（温泉）**:
- 温泉名
- 住所
- 料金
- 営業時間
- レビュー

**表示内容（コンビニ）**:
- 店名
- ブランド
- 住所
- 営業時間

**表示高さ**: 画面の45%

**ファイルパス**: `src/screens/SpotDetailBottomSheet.tsx`

---

### 5.2 認証画面

#### LoginScreen（ログイン画面）
**機能**:
- メールアドレス + パスワードでログイン
- Google OAuthログイン
- 「パスワードを忘れた」リンク
- 「新規登録」リンク

**バリデーション**:
- メールアドレス形式チェック
- パスワード必須チェック

**ファイルパス**: `src/screens/auth/LoginScreen.tsx`

---

#### SignUpScreen（新規登録画面）
**機能**:
- メールアドレス + パスワードで新規登録
- 表示名（ニックネーム）入力
- 利用規約への同意チェック

**バリデーション**:
- メールアドレス形式
- パスワード: 6文字以上
- 表示名: 必須

**登録フロー**:
1. Supabase Authでユーザー作成
2. `user_profiles` テーブルにプロフィール作成（UPSERT で重複回避）
3. 自動ログイン

**ファイルパス**: `src/screens/auth/SignUpScreen.tsx`

---

#### ForgotPasswordScreen（パスワードリセット画面）
**機能**:
- メールアドレス入力
- パスワードリセットメール送信

**ファイルパス**: `src/screens/auth/ForgotPasswordScreen.tsx`

---

#### TermsOfServiceScreen（利用規約画面）
**機能**:
- 利用規約の表示

**ファイルパス**: `src/screens/auth/TermsOfServiceScreen.tsx`

---

### 5.3 ユーザー画面

#### ProfileScreen（プロフィール画面）
**機能**:
- ユーザー情報表示（表示名、メールアドレス）
- プロフィール編集
- ログアウト

**ファイルパス**: `src/screens/ProfileScreen.tsx`

---

#### FavoritesScreen（お気に入り画面）
**機能**:
- お気に入りに追加した駐車場のリスト表示
- タップで地図に移動して詳細表示
- お気に入りから削除

**データ取得**:
- `favorites` テーブルから user_id で絞り込み
- `parking_spots` と JOIN して詳細情報取得

**ファイルパス**: `src/screens/FavoritesScreen.tsx`

---

#### MyReviewsScreen（マイレビュー画面）
**機能**:
- 自分が投稿したレビューのリスト表示
- 駐車場レビューと温泉レビューを分けて表示
- レビューの編集・削除

**データ取得**:
- `parking_reviews` と `hot_spring_reviews` から user_id で絞り込み

**ファイルパス**: `src/screens/MyReviewsScreen.tsx`

---

### 5.4 設定・情報画面

#### SettingsScreen（設定画面）
**機能**:
- アプリ設定
- 通知設定
- キャッシュクリア
- バージョン情報

**ファイルパス**: `src/screens/SettingsScreen.tsx`

---

#### HelpScreen（ヘルプ画面）
**機能**:
- よくある質問（FAQ）
- 使い方ガイド
- お問い合わせ

**ファイルパス**: `src/screens/HelpScreen.tsx`

---

#### AboutScreen（アプリについて画面）
**機能**:
- アプリ情報
- バージョン番号
- 開発者情報

**ファイルパス**: `src/screens/AboutScreen.tsx`

---

#### GuideScreen（ガイド画面）
**機能**:
- アプリの使い方チュートリアル
- 機能説明

**ファイルパス**: `src/screens/GuideScreen.tsx`

---

#### TermsScreen（利用規約画面）
**機能**:
- 利用規約の全文表示

**ファイルパス**: `src/screens/TermsScreen.tsx`

---

#### PrivacyScreen（プライバシーポリシー画面）
**機能**:
- プライバシーポリシーの全文表示

**ファイルパス**: `src/screens/PrivacyScreen.tsx`

---

#### PremiumScreen（プレミアム機能画面）
**機能**:
- 将来の有料機能の説明
- サブスクリプション購入

**ファイルパス**: `src/screens/PremiumScreen.tsx`

---

### 5.5 ユーザー投稿機能

#### AddParkingScreen（駐車場投稿画面）
**役割**: ユーザーが駐車場の看板写真を撮影・アップロードして新しい駐車場情報を投稿

**主要機能**:
1. **写真撮影/選択**
   - カメラで撮影
   - ギャラリーから選択
   - アスペクト比制限なし（自由なサイズ）

2. **画像アップロード**
   - Supabase Storage の `parking-submissions` バケットにアップロード
   - ファイル名: `{userId}/{timestamp}.jpg`

3. **自動OCR処理**
   - Edge Function `process-parking-image` が自動トリガー
   - Gemini 2.5 Flash API で看板をOCR
   - 料金構造を正規化してJSON化
   - 信頼度スコア（0.0～1.0）を計算

4. **投稿完了**
   - `parking_submissions` テーブルに保存
   - ステータス: `pending`（承認待ち）

**OCR抽出データ例**:
```json
{
  "name": "タイムズ渋谷駅前",
  "address": "東京都渋谷区渋谷1-1-1",
  "latitude": 35.658581,
  "longitude": 139.701439,
  "capacity": 50,
  "rates": [
    { "type": "base", "minutes": 30, "price": 0 },
    { "type": "progressive", "minutes": 30, "price": 250, "apply_after": 30 },
    { "type": "max", "minutes": 1440, "price": 2400 }
  ],
  "hours": {
    "is_24h": true
  },
  "nearest_convenience_store": {
    "id": "12345",
    "name": "セブン-イレブン 渋谷駅前店",
    "distance": 120
  },
  "nearest_hot_spring": {
    "id": "456",
    "name": "渋温泉",
    "distance": 2500
  }
}
```

**ファイルパス**: `src/screens/AddParkingScreen.tsx`

---

#### AdminSubmissionsScreen（投稿管理画面）
**役割**: 管理者がユーザー投稿を承認・却下・編集する

**主要機能**:
1. **投稿リスト表示**
   - ステータスでフィルタ（pending, approved, rejected）
   - 信頼度スコアで並び替え
   - サムネイル画像表示

2. **投稿詳細表示**
   - 元の写真を拡大表示
   - OCR抽出データをプレビュー
   - 信頼度スコア表示
   - 投稿者情報

3. **JSON直接編集**
   - リアルタイムバリデーション
   - フォーマットエラー検出
   - 料金構造の妥当性チェック

4. **重複チェック**
   - 同じ座標（lat, lng）の駐車場を検出
   - 同じ名前の駐車場を検出
   - 重複時はダイアログ表示
     - [キャンセル] ボタン: 承認を中止
     - [OK] ボタン: 既存データを更新（画像を追加）
     - [新規登録] ボタン（名前重複のみ）: 別の駐車場として登録

5. **承認処理**
   - `parking_spots` テーブルに新規挿入
   - または既存データを更新
   - 周辺施設データも保存
   - ステータスを `approved` に変更

6. **却下処理**
   - ステータスを `rejected` に変更
   - 画像は保持（再審査可能）

**デバッグログ**:
- コンビニデータ: `nearest_convenience_store` と `nearestConvenienceStore` の両方をチェック
- 温泉データ: `nearest_hot_spring` と `nearest_hotspring` の両方をチェック
- OCRの key naming の不一致に対応

**ファイルパス**: `src/screens/AdminSubmissionsScreen.tsx`

---

### 5.6 テスト・デバッグ画面

#### TestAuth（認証テスト画面）
**機能**: 認証フローのテスト

#### TestMapBounds（地図範囲テスト画面）
**機能**: 地図の範囲計算テスト

#### TestDataFetch（データ取得テスト画面）
**機能**: Supabaseからのデータ取得テスト

#### DebugSupabase（Supabase デバッグ画面）
**機能**: 直接SQLクエリを実行してデバッグ

#### TestOperatingHours（営業時間パーステスト画面）
**機能**: 営業時間の解析テスト

#### TestNearbyData（周辺データテスト画面）
**機能**: 周辺施設検索のテスト

#### TestParkingFeeAdvanced（料金計算テスト画面）
**機能**: 複雑な料金体系の計算テスト

#### TestParkingType（駐車場タイプテスト画面）
**機能**: 駐車場タイプ別フィルタのテスト

---

## 6. サービス層

### 6.1 SupabaseService（データ取得サービス）
**ファイルパス**: `src/services/supabase.service.ts`

**主要メソッド**:

```typescript
class SupabaseService {
  // 駐車場検索
  static async searchParkingSpots(
    region: Region,
    filter: SearchFilter
  ): Promise<CoinParking[]>

  // RPC: 料金順ソート済み駐車場取得（サーバー側で料金計算）
  static async getParkingSpotsSortedByFee(
    region: Region,
    durationMinutes: number,
    parkingStart: Date
  ): Promise<{ spots: CoinParking[], totalCount: number }>

  // コンビニ検索
  static async searchConvenienceStores(
    region: Region
  ): Promise<ConvenienceStore[]>

  // 温泉検索
  static async searchHotSprings(
    region: Region
  ): Promise<HotSpring[]>

  // ガソリンスタンド検索
  static async searchGasStations(
    region: Region
  ): Promise<GasStation[]>

  // お祭り検索
  static async searchFestivals(
    region: Region
  ): Promise<Festival[]>

  // 駐車場詳細取得
  static async getParkingSpotById(
    id: string
  ): Promise<CoinParking | null>

  // 温泉詳細取得
  static async getHotSpringById(
    id: string
  ): Promise<HotSpring | null>

  // コンビニ詳細取得
  static async getConvenienceStoreById(
    id: string
  ): Promise<ConvenienceStore | null>
}
```

**データベースクエリ例**:
```typescript
// 駐車場検索（料金順）
const { data, error } = await supabase.rpc('get_parking_spots_sorted_by_fee', {
  min_lat: region.latitude - region.latitudeDelta / 2,
  max_lat: region.latitude + region.latitudeDelta / 2,
  min_lng: region.longitude - region.longitudeDelta / 2,
  max_lng: region.longitude + region.longitudeDelta / 2,
  duration_minutes: durationMinutes,
  parking_start: parkingStart.toISOString(),
});
```

---

### 6.2 SearchService（検索・フィルタサービス）
**ファイルパス**: `src/services/search.service.ts`

**主要メソッド**:

```typescript
class SearchService {
  // 統合検索（全カテゴリ）
  static async search(
    region: Region,
    filter: SearchFilter,
    parkingStart?: Date,
    durationMinutes?: number
  ): Promise<{
    results: Spot[];
    stats: {
      parking: number;
      convenience: number;
      hotspring: number;
      gasStation: number;
      festival: number;
    };
  }>

  // フィルタ適用
  static applyFilters(
    spots: Spot[],
    filter: SearchFilter
  ): Spot[]

  // 周辺施設フィルタ（OR検索）
  static filterByNearbyFacilities(
    parkingSpots: CoinParking[],
    filter: SearchFilter
  ): CoinParking[]

  // 標高フィルタ
  static filterByElevation(
    spots: Spot[],
    minElevation: number
  ): Spot[]

  // 駐車場タイプフィルタ
  static filterByParkingType(
    parkingSpots: CoinParking[],
    filter: SearchFilter
  ): CoinParking[]
}
```

**フィルタロジック**:
1. カテゴリフィルタ
2. 標高フィルタ（最低標高以上）
3. 周辺施設フィルタ（OR検索）
4. 駐車場タイプフィルタ（平面、立体、機械式）
5. 駐車料金計算（指定時間）
6. 料金順ソート（駐車場のみ）

---

### 6.3 ParkingFeeCalculator（駐車料金計算サービス）
**ファイルパス**: `src/services/parking-fee.service.ts`

**主要メソッド**:

```typescript
class ParkingFeeCalculator {
  // 駐車料金計算（メインメソッド）
  static calculateFee(
    rates: ParkingRate[],
    durationMinutes: number,
    parkingStart?: Date
  ): number

  // 料金情報のフォーマット
  static formatFeeInfo(
    rates: ParkingRate[]
  ): string

  // 営業時間チェック
  static isOpenDuringParking(
    hours: HoursInfo,
    parkingStart: Date,
    durationMinutes: number
  ): boolean

  // 営業状態の文字列生成
  static getOperatingStatus(
    hours: HoursInfo,
    parkingStart: Date
  ): string
}
```

**計算アルゴリズム**:
1. **料金の正規化**: snake_case → camelCase
2. **時間帯分割**: 駐車時間を時間帯ごとに分割
3. **累進料金の適用**: `applyAfter` を考慮
4. **最大料金の適用**: 時間枠内での上限
5. **24時間超の時刻対応**: "25:30" → "01:30" に正規化

**料金計算例**:
```typescript
// 料金構造
rates = [
  { type: 'base', minutes: 30, price: 0 },
  { type: 'progressive', minutes: 30, price: 250, applyAfter: 30 },
  { type: 'max', minutes: 1440, price: 2400 }
];

// 2時間駐車（120分）
fee = calculateFee(rates, 120);
// → 750円
// 計算: 最初30分0円 + 残り90分(3×30分)×250円 = 750円
```

---

### 6.4 LocationService（位置情報サービス）
**ファイルパス**: `src/services/location.service.ts`

**主要メソッド**:

```typescript
class LocationService {
  // 位置情報権限リクエスト
  static async requestPermission(): Promise<'granted' | 'denied' | 'restricted'>

  // 現在地取得（1回）
  static async getCurrentLocation(): Promise<Location | null>

  // リアルタイム位置追跡
  static async watchLocation(
    callback: (location: Location) => void,
    options?: LocationTaskOptions
  ): Promise<LocationSubscription>

  // ジオコーディング（住所 → 座標）
  static async geocode(
    query: string
  ): Promise<{ latitude: number; longitude: number } | null>

  // 距離計算（Haversine式）
  static calculateDistance(
    from: Location,
    to: { lat: number; lng: number }
  ): number

  // 距離フォーマット
  static formatDistance(
    meters: number
  ): string  // "120m" or "1.5km"
}
```

**位置情報設定**:
```typescript
{
  accuracy: Location.Accuracy.High,
  maximumAge: 10000,  // 10秒以内のキャッシュを使用
  timeout: 15000,     // 15秒でタイムアウト
}
```

**リアルタイム追跡設定**:
```typescript
{
  accuracy: Location.Accuracy.High,
  timeInterval: 2000,       // 2秒ごと
  distanceInterval: 10,     // 10m移動ごと
}
```

---

### 6.5 AuthService（認証サービス）
**ファイルパス**: `src/services/auth.service.ts`

**主要メソッド**:

```typescript
class AuthService {
  // メールアドレス登録
  static async signUp(
    email: string,
    password: string,
    displayName: string
  ): Promise<{ user: User; error: Error | null }>

  // メールアドレスログイン
  static async signIn(
    email: string,
    password: string
  ): Promise<{ user: User; error: Error | null }>

  // Google OAuthログイン
  static async signInWithGoogle(): Promise<{ user: User; error: Error | null }>

  // ログアウト
  static async signOut(): Promise<void>

  // パスワードリセット
  static async resetPassword(
    email: string
  ): Promise<{ error: Error | null }>

  // プロフィール作成（重複チェック付き）
  static async createProfileSafely(
    userId: string,
    displayName: string
  ): Promise<{ error: Error | null }>

  // セッション検証
  static async validateSession(): Promise<boolean>
}
```

**認証フロー**:
1. `signUp` or `signIn` → Supabase Auth
2. `createProfileSafely` → `user_profiles` テーブル（UPSERT）
3. `useAuthStore` に状態を保存
4. AsyncStorage にセッション保持

---

### 6.6 ReviewService（レビューサービス）
**ファイルパス**: `src/services/review.service.ts`

**主要メソッド**:

```typescript
class ReviewService {
  // レビュー投稿（駐車場）
  static async createParkingReview(
    parkingSpotId: string,
    userId: string,
    content: string,
    rating: number
  ): Promise<{ error: Error | null }>

  // レビュー投稿（温泉）
  static async createHotSpringReview(
    hotSpringId: string,
    userId: string,
    content: string,
    rating: number
  ): Promise<{ error: Error | null }>

  // レビュー取得（駐車場）
  static async getParkingReviews(
    parkingSpotId: string
  ): Promise<Review[]>

  // レビュー取得（温泉）
  static async getHotSpringReviews(
    hotSpringId: string
  ): Promise<Review[]>

  // レビュー削除
  static async deleteReview(
    reviewId: string,
    userId: string
  ): Promise<{ error: Error | null }>

  // ユーザーのレビュー一覧
  static async getUserReviews(
    userId: string
  ): Promise<{ parking: Review[]; hotspring: Review[] }>
}
```

**レビュー構造**:
```typescript
interface Review {
  id: string;
  parking_spot_id?: string;
  hot_spring_id?: string;
  user_id: string;
  content: string;
  rating: number;  // 1～5
  created_at: string;
  user_display_name?: string;
}
```

---

### 6.7 FavoritesService（お気に入りサービス）
**ファイルパス**: `src/services/favorites.service.ts`

**主要メソッド**:

```typescript
class FavoritesService {
  // お気に入りに追加
  static async addFavorite(
    userId: string,
    parkingSpotId: string
  ): Promise<{ error: Error | null }>

  // お気に入りから削除
  static async removeFavorite(
    userId: string,
    parkingSpotId: string
  ): Promise<{ error: Error | null }>

  // お気に入りチェック
  static async isFavorite(
    userId: string,
    parkingSpotId: string
  ): Promise<boolean>

  // お気に入り一覧取得
  static async getFavorites(
    userId: string
  ): Promise<CoinParking[]>
}
```

---

## 7. 状態管理

### 7.1 useMainStore（メイン状態管理）
**ファイルパス**: `src/stores/useMainStore.ts`

**状態定義**:
```typescript
interface MainStore {
  // 地図と検索
  mapRegion: Region;
  searchFilter: SearchFilter;
  searchResults: Spot[];
  selectedSpot: Spot | null;

  // UI状態
  showingSpotDetail: boolean;
  isLoading: boolean;
  errorMessage: string | null;
  appBootReady: boolean;

  // 位置情報
  userLocation: Location | null;
  locationPermission: 'granted' | 'denied' | 'restricted' | null;

  // アクション
  setMapRegion: (region: Region) => void;
  setSearchFilter: (filter: Partial<SearchFilter>) => void;
  setSearchResults: (results: Spot[]) => void;
  selectSpot: (spot: Spot | null) => void;
  setUserLocation: (location: Location | null) => void;
  setAppBootReady: (ready: boolean) => void;
}
```

**初期状態**:
```typescript
{
  mapRegion: {
    latitude: 35.6812,   // 東京駅
    longitude: 139.7671,
    latitudeDelta: 0.02,
    longitudeDelta: 0.02,
  },
  searchFilter: {
    selectedCategories: new Set(['コインパーキング']),
    searchRadius: 5000,
    minElevation: 0,
    parkingTimeFilterEnabled: true,
    radiusFilterEnabled: false,
    elevationFilterEnabled: false,
    nearbyCategories: new Set(),
    convenienceStoreRadius: 500,
    toiletRadius: 500,
    hotSpringRadius: 5000,
    showFlatParking: true,
    showMultiStoryParking: true,
    showMechanicalParking: true,
    parkingDuration: new ParkingDuration(),
  },
  searchResults: [],
  selectedSpot: null,
  isLoading: false,
  errorMessage: null,
  appBootReady: false,
  userLocation: null,
  locationPermission: null,
}
```

---

### 7.2 useAuthStore（認証状態管理）
**ファイルパス**: `src/stores/useAuthStore.ts`

**状態定義**:
```typescript
interface AuthStore {
  // 認証状態
  user: User | null;
  session: Session | null;
  profile: UserProfile | null;
  isAuthenticated: boolean;
  isLoading: boolean;

  // アクション
  setUser: (user: User | null) => void;
  setSession: (session: Session | null) => void;
  setProfile: (profile: UserProfile | null) => void;
  signOut: () => Promise<void>;
  initializeAuth: () => Promise<void>;
  checkAuth: () => Promise<void>;
}
```

**認証初期化**:
```typescript
async initializeAuth() {
  // 1. Supabase Session の取得
  const { data: { session } } = await supabase.auth.getSession();

  // 2. セッションがあればユーザー情報を設定
  if (session) {
    this.setSession(session);
    this.setUser(session.user);

    // 3. プロフィール取得
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('*')
      .eq('id', session.user.id)
      .single();

    this.setProfile(profile);
  }

  // 4. 認証状態の変化を監視
  supabase.auth.onAuthStateChange((event, session) => {
    this.setSession(session);
    this.setUser(session?.user ?? null);
  });
}
```

---

## 8. データベース設計

### 8.1 parking_spots（駐車場テーブル）
```sql
CREATE TABLE parking_spots (
  id BIGSERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  lat DOUBLE PRECISION NOT NULL,
  lng DOUBLE PRECISION NOT NULL,
  address TEXT,
  description TEXT,
  rates JSONB,                -- 料金配列
  hours JSONB,                -- 営業時間
  capacity INTEGER,
  payment_methods TEXT,
  restrictions TEXT,
  vehicle_dimensions JSONB,
  parking_type TEXT,          -- 平面駐車場、立体駐車場、機械式、車中泊・キャンプ場
  nearest_convenience_store JSONB,  -- { id, name, brand, distance }
  nearest_hotspring JSONB,          -- { id, name, distance }
  nearest_toilet JSONB,             -- { id, name, distance }
  elevation DOUBLE PRECISION,
  prefecture TEXT,
  images TEXT[],              -- 画像URL配列
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_parking_spots_location ON parking_spots USING GIST (
  ll_to_earth(lat, lng)
);
CREATE INDEX idx_parking_spots_elevation ON parking_spots (elevation);
CREATE INDEX idx_parking_spots_parking_type ON parking_spots (parking_type);
```

**rates JSONBフォーマット**:
```json
[
  {
    "type": "base",
    "minutes": 30,
    "price": 0,
    "time_range": "8:00～20:00"
  },
  {
    "type": "progressive",
    "minutes": 30,
    "price": 250,
    "apply_after": 30,
    "time_range": "8:00～20:00"
  },
  {
    "type": "base",
    "minutes": 60,
    "price": 100,
    "time_range": "20:00～8:00"
  },
  {
    "type": "max",
    "minutes": 1440,
    "price": 2400
  }
]
```

**hours JSONBフォーマット**:
```json
{
  "is_24h": false,
  "hours": "8:00～22:00",
  "original_hours": "8時から22時まで",
  "access_24h": false,
  "closed_days": ["年末年始"],
  "restrictions": []
}
```

---

### 8.2 convenience_stores（コンビニテーブル）
```sql
CREATE TABLE convenience_stores (
  id BIGSERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  lat DOUBLE PRECISION NOT NULL,
  lng DOUBLE PRECISION NOT NULL,
  brand TEXT,               -- Seven-Eleven, Lawson, FamilyMart等
  sub_type TEXT,
  phone_number TEXT,
  operating_hours TEXT,
  address TEXT,
  elevation DOUBLE PRECISION,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_convenience_stores_location ON convenience_stores USING GIST (
  ll_to_earth(lat, lng)
);
CREATE INDEX idx_convenience_stores_brand ON convenience_stores (brand);
```

---

### 8.3 hot_springs（温泉テーブル）
```sql
CREATE TABLE hot_springs (
  id BIGSERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  lat DOUBLE PRECISION NOT NULL,
  lng DOUBLE PRECISION NOT NULL,
  address TEXT,
  price TEXT,
  operating_hours TEXT,
  holiday_info TEXT,
  facility_type TEXT,
  description TEXT,
  elevation DOUBLE PRECISION,
  prefecture TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_hot_springs_location ON hot_springs USING GIST (
  ll_to_earth(lat, lng)
);
```

---

### 8.4 gas_stations（ガソリンスタンドテーブル）
```sql
CREATE TABLE gas_stations (
  id BIGSERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  lat DOUBLE PRECISION NOT NULL,
  lng DOUBLE PRECISION NOT NULL,
  brand TEXT,
  services JSONB,           -- { regular_price, premium_price, diesel_price }
  operating_hours TEXT,
  address TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_gas_stations_location ON gas_stations USING GIST (
  ll_to_earth(lat, lng)
);
```

---

### 8.5 festivals（お祭りテーブル）
```sql
CREATE TABLE festivals (
  id BIGSERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  lat DOUBLE PRECISION NOT NULL,
  lng DOUBLE PRECISION NOT NULL,
  address TEXT,
  event_date TEXT,
  event_type TEXT,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_festivals_location ON festivals USING GIST (
  ll_to_earth(lat, lng)
);
```

---

### 8.6 user_profiles（ユーザープロフィールテーブル）
```sql
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name TEXT NOT NULL,
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

### 8.7 parking_reviews（駐車場レビューテーブル）
```sql
CREATE TABLE parking_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  parking_spot_id BIGINT NOT NULL REFERENCES parking_spots(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_parking_reviews_parking_spot_id ON parking_reviews (parking_spot_id);
CREATE INDEX idx_parking_reviews_user_id ON parking_reviews (user_id);
```

---

### 8.8 hot_spring_reviews（温泉レビューテーブル）
```sql
CREATE TABLE hot_spring_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  hot_spring_id BIGINT NOT NULL REFERENCES hot_springs(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_hot_spring_reviews_hot_spring_id ON hot_spring_reviews (hot_spring_id);
CREATE INDEX idx_hot_spring_reviews_user_id ON hot_spring_reviews (user_id);
```

---

### 8.9 favorites（お気に入りテーブル）
```sql
CREATE TABLE favorites (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  parking_spot_id BIGINT NOT NULL REFERENCES parking_spots(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE (user_id, parking_spot_id)
);

CREATE INDEX idx_favorites_user_id ON favorites (user_id);
```

---

### 8.10 parking_submissions（駐車場投稿テーブル）
```sql
CREATE TABLE parking_submissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  image_url TEXT NOT NULL,
  extracted_data JSONB,         -- OCR抽出データ
  confidence_score NUMERIC(3, 2) CHECK (confidence_score >= 0 AND confidence_score <= 1),
  submission_status TEXT NOT NULL DEFAULT 'pending',  -- pending, approved, rejected
  parking_spot_id BIGINT REFERENCES parking_spots(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_parking_submissions_user_id ON parking_submissions (user_id);
CREATE INDEX idx_parking_submissions_status ON parking_submissions (submission_status);
CREATE INDEX idx_parking_submissions_confidence ON parking_submissions (confidence_score DESC);
```

---

### 8.11 SQL関数

#### normalize_time_string（24時間超の時刻正規化）
```sql
CREATE OR REPLACE FUNCTION normalize_time_string(time_str text)
RETURNS time
LANGUAGE plpgsql
IMMUTABLE
AS $$
DECLARE
  hour_part integer;
  minute_part integer;
  normalized_hour integer;
BEGIN
  -- "25:30" → "01:30" に正規化
  hour_part := split_part(time_str, ':', 1)::integer;
  minute_part := split_part(time_str, ':', 2)::integer;
  normalized_hour := hour_part % 24;
  RETURN make_time(normalized_hour, minute_part, 0);
EXCEPTION
  WHEN OTHERS THEN
    RETURN '00:00:00'::time;
END;
$$;
```

#### calculate_simple_parking_fee（駐車料金計算）
```sql
CREATE OR REPLACE FUNCTION calculate_simple_parking_fee(
  rates jsonb,
  parking_start timestamptz,
  duration_minutes integer
)
RETURNS integer
LANGUAGE plpgsql
AS $$
DECLARE
  base_rate jsonb := NULL;
  progressive_rate jsonb := NULL;
  max_rate jsonb := NULL;
  best_cost integer := 0;
  -- その他の変数...
BEGIN
  -- 料金タイプごとに適用可能な料金を選択
  -- 時間帯チェック（24時間超対応）
  -- 累進料金の計算
  -- 最大料金の適用
  RETURN best_cost;
END;
$$;
```

#### get_parking_spots_sorted_by_fee（料金順ソート済み駐車場取得RPC）
```sql
CREATE OR REPLACE FUNCTION get_parking_spots_sorted_by_fee(
  min_lat double precision,
  max_lat double precision,
  min_lng double precision,
  max_lng double precision,
  duration_minutes integer,
  parking_start timestamptz
)
RETURNS TABLE (
  id bigint,
  name text,
  lat double precision,
  lng double precision,
  -- その他のフィールド...
  calculated_fee integer,
  total_count integer
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  WITH filtered_spots AS (
    SELECT * FROM parking_spots
    WHERE lat BETWEEN min_lat AND max_lat
      AND lng BETWEEN min_lng AND max_lng
  ),
  calculated AS (
    SELECT
      *,
      calculate_simple_parking_fee(rates, parking_start, duration_minutes) AS fee
    FROM filtered_spots
  )
  SELECT
    *,
    COUNT(*) OVER () AS total_count
  FROM calculated
  ORDER BY fee ASC NULLS LAST
  LIMIT 20;
END;
$$;
```

---

### 8.12 Supabase Storage

#### parking-submissions バケット
**用途**: ユーザーが投稿した駐車場看板の写真を保存

**設定**:
- Public: false（認証ユーザーのみアクセス可）
- File size limit: 10MB
- Allowed MIME types: image/jpeg, image/png

**ディレクトリ構造**:
```
parking-submissions/
  ├── {userId}/
  │   ├── {timestamp1}.jpg
  │   ├── {timestamp2}.jpg
  │   └── ...
```

**アップロード例**:
```typescript
const { data, error } = await supabase.storage
  .from('parking-submissions')
  .upload(`${userId}/${Date.now()}.jpg`, file);
```

---

### 8.13 Supabase Edge Functions

#### process-parking-image
**言語**: Deno (TypeScript)

**トリガー**: Storage webhook（parking-submissions バケットへのファイルアップロード）

**処理フロー**:
1. 画像をダウンロード
2. Gemini 2.5 Flash API でOCR実行
3. 駐車場データを正規化（料金構造、営業時間、住所等）
4. 信頼度スコア計算（全フィールドの完全性）
5. `parking_submissions` テーブルに結果を保存

**Gemini API プロンプト**:
```
この駐車場の看板画像から以下の情報を抽出してJSONで返してください：
- name: 駐車場名
- address: 住所
- latitude: 緯度
- longitude: 経度
- capacity: 収容台数
- rates: 料金配列
  - type: "base" | "progressive" | "max"
  - minutes: 時間（分）
  - price: 料金（円）
  - apply_after: 累進料金の適用開始時間（分）
  - time_range: 時間帯（例: "8:00～20:00"）
- hours: 営業時間
  - is_24h: 24時間営業かどうか
  - hours: 営業時間文字列
- nearest_convenience_store: 最寄りのコンビニ（名前と距離）
- nearest_hot_spring: 最寄りの温泉（名前と距離）
```

**環境変数**:
```bash
GEMINI_API_KEY="AIzaSy..."
```

**デプロイコマンド**:
```bash
npx supabase functions deploy process-parking-image
npx supabase secrets set GEMINI_API_KEY="your_key"
```

---

## 9. UI/UXパターン

### 9.1 二段階タップ操作
**目的**: 誤タップを防ぎつつ、詳細情報にアクセスしやすくする

**動作**:
1. **1回目のタップ**: マーカーのコールアウト表示
   - 駐車場名
   - 料金（計算済み）
   - 距離（現在地から）

2. **2回目のタップ**: 詳細ボトムシート表示
   - 完全な情報
   - レビュー
   - アクションボタン

**実装**:
```typescript
const [selectedSpot, setSelectedSpot] = useState<Spot | null>(null);
const [showDetailSheet, setShowDetailSheet] = useState(false);

const handleMarkerPress = (spot: Spot) => {
  if (selectedSpot?.id === spot.id) {
    // 2回目のタップ → 詳細シート表示
    setShowDetailSheet(true);
  } else {
    // 1回目のタップ → 選択のみ
    setSelectedSpot(spot);
    setShowDetailSheet(false);
  }
};
```

---

### 9.2 ランキングリストからの詳細表示
**問題**: React Nativeではモーダルを重ねられない

**解決策**:
1. ランキングモーダルを閉じる
2. `setTimeout` で50ms待つ
3. 詳細ボトムシートを開く

**実装**:
```typescript
const handleRankingSpotDetail = async (spot: Spot) => {
  setShowRankingModal(false);  // モーダルを閉じる

  setTimeout(() => {
    selectSpot(spot);           // スポットを選択
    setShowDetailSheet(true);   // 詳細シートを開く
  }, 50);
};
```

---

### 9.3 ビジュアル階層

#### マーカーの視覚的重要度
1. **金メダル（1位）**: 最も目立つ
2. **銀メダル（2位）**: 次に目立つ
3. **銅メダル（3位）**: 3番目
4. **青い番号マーカー（4～20位）**: 順位を表示
5. **選択中マーカー**: 1.3倍スケール + 赤枠

#### モーダル/シートの高さ
- **ランキングモーダル**: 画面の50%
- **詳細ボトムシート**: 画面の45%
- **フィルタパネル**: 固定高さ（内容により可変）

---

### 9.4 カラースキーム
```typescript
const Colors = {
  primary: '#1976d2',       // 青（メイン）
  secondary: '#4CAF50',     // 緑（コンビニ）
  accent: '#FFD700',        // 金（温泉）
  warning: '#FF9800',       // オレンジ（ガソリンスタンド）
  error: '#f44336',         // 赤（エラー）
  background: '#FFFFFF',    // 白
  surface: '#F5F5F5',       // ライトグレー
  text: '#212121',          // ダークグレー
  textSecondary: '#757575', // グレー
};
```

---

### 9.5 フィードバック

#### ローディング状態
- **地図初期化中**: 全画面ローディングオーバーレイ + スピナー
- **検索中**: 半透明オーバーレイ + スピナー
- **位置情報取得中**: 小さな白いピル型テキスト（画面下部）

#### トースト通知
- **位置情報取得中**: "📍 現在地を取得中..."
- **取得失敗**: "⚠️ 現在地を取得できませんでした"
- 3秒後に自動で消える

#### エラー表示
- **重要なエラー**: `Alert.alert` でダイアログ表示
- **デバッグエラー**: `console.log` のみ（アプリ上には表示しない）

---

## 10. 駐車料金計算アルゴリズム

### 10.1 料金タイプ

#### base（基本料金）
最初の時間単位に適用される料金

**例**:
```json
{ "type": "base", "minutes": 30, "price": 0 }
```
→ 最初の30分は無料

#### progressive（累進料金）
`applyAfter` 分経過後に適用される料金

**例**:
```json
{ "type": "progressive", "minutes": 30, "price": 250, "applyAfter": 30 }
```
→ 30分経過後、30分ごとに250円

#### max（最大料金）
指定時間枠内での上限

**例**:
```json
{ "type": "max", "minutes": 1440, "price": 2400 }
```
→ 24時間（1440分）以内なら最大2400円

---

### 10.2 時間帯別料金

**時間帯の表記**:
```json
{ "time_range": "8:00～20:00" }
```

**24時間超の表記対応**:
```json
{ "time_range": "25:30～5:30" }
```
→ `normalize_time_string()` で "01:30～05:30" に正規化

---

### 10.3 計算例

#### 例1: 基本 + 累進 + 最大
**料金構造**:
```json
[
  { "type": "base", "minutes": 30, "price": 0 },
  { "type": "progressive", "minutes": 30, "price": 250, "applyAfter": 30 },
  { "type": "max", "minutes": 1440, "price": 2400 }
]
```

**駐車時間**: 2時間（120分）

**計算**:
1. 最初30分: 0円（base）
2. 残り90分: 90 / 30 = 3ブロック × 250円 = 750円（progressive）
3. 合計: 0 + 750 = **750円**
4. 最大料金チェック: 750円 < 2400円 → **750円**

---

#### 例2: 24時間超の駐車
**料金構造**:
```json
[
  { "type": "base", "minutes": 60, "price": 100 },
  { "type": "max", "minutes": 1440, "price": 1000 }
]
```

**駐車時間**: 50時間（3000分）

**計算**:
1. 最初の24時間（1440分）: 1000円（max）
2. 次の24時間（1440分）: 1000円（max）
3. 残り2時間（120分）: 120 / 60 × 100 = 200円（base）
4. 合計: 1000 + 1000 + 200 = **2200円**

**注**: サーバー側の `calculate_parking_fee_dp_with_repeat` 関数は、24時間最大料金を繰り返し適用します。

---

#### 例3: 時間帯別料金
**料金構造**:
```json
[
  { "type": "base", "minutes": 60, "price": 300, "time_range": "8:00～20:00" },
  { "type": "base", "minutes": 60, "price": 100, "time_range": "20:00～8:00" },
  { "type": "max", "minutes": 1440, "price": 2000 }
]
```

**駐車時間**: 19:00～翌9:00（14時間）

**計算**:
1. **昼間帯（19:00～20:00）**: 1時間 × 300円 = 300円
2. **夜間帯（20:00～8:00）**: 12時間 × 100円 = 1200円
3. **昼間帯（8:00～9:00）**: 1時間 × 300円 = 300円
4. 合計: 300 + 1200 + 300 = **1800円**
5. 最大料金チェック: 1800円 < 2000円 → **1800円**

---

### 10.4 フォーマット表示

**入力**:
```json
[
  { "type": "base", "minutes": 30, "price": 0 },
  { "type": "progressive", "minutes": 30, "price": 250, "applyAfter": 30 },
  { "type": "max", "minutes": 1440, "price": 2400 }
]
```

**出力**:
```
30分未満無料、30分以降入庫から30分毎¥250、24時間最大¥2,400
```

**実装**: `ParkingFeeCalculator.formatFeeInfo()`

---

## 11. 位置情報機能

### 11.1 初回起動時の動作
1. **ローディングオーバーレイ表示** (`isInitializingMap: true`)
2. **前回の地図範囲を復元** (AsyncStorage から読み込み)
3. **地図を表示** (`isInitializingMap: false`)
4. **並行して現在地を取得**
5. **現在地取得成功** → 現在地に移動（1秒アニメーション）
6. **現在地取得失敗** → 前回の位置を継続使用
7. **前回の位置もない** → 東京駅をデフォルト表示

### 11.2 GPS精度設定
```typescript
{
  accuracy: Location.Accuracy.High,
  maximumAge: 10000,  // 10秒以内のキャッシュ使用
  timeout: 15000,     // 15秒でタイムアウト
}
```

### 11.3 リアルタイム位置追跡
**トリガー**: 現在地ボタン（右下の青いボタン）をタップ

**更新間隔**:
- 2秒ごと
- または10m移動ごと

**停止**: もう一度ボタンをタップ

### 11.4 位置情報権限
- **granted**: 常に許可
- **denied**: 拒否
- **restricted**: 制限（ペアレンタルコントロール等）

**権限リクエスト**: アプリ起動時に自動で実行

---

## 12. 認証・ユーザー管理

### 12.1 認証方式
1. **メールアドレス + パスワード**
2. **Google OAuth**

### 12.2 認証フロー

#### 新規登録
1. `SignUpScreen` でメール・パスワード・表示名を入力
2. `AuthService.signUp()` → Supabase Auth
3. `AuthService.createProfileSafely()` → `user_profiles` テーブル（UPSERT）
4. `useAuthStore` に状態保存
5. AsyncStorage にセッション保持
6. MapScreen に自動遷移

#### ログイン
1. `LoginScreen` でメール・パスワードを入力
2. `AuthService.signIn()` → Supabase Auth
3. セッション取得 → `useAuthStore` に保存
4. プロフィール取得 → `user_profiles` テーブル
5. MapScreen に自動遷移

#### Google OAuth
1. `LoginScreen` で「Googleでログイン」ボタンをタップ
2. `AuthService.signInWithGoogle()` → Supabase Auth
3. ブラウザでGoogle認証
4. コールバック: `car-concierge-app://auth/callback`
5. セッション取得 → `useAuthStore` に保存
6. プロフィールが存在しない場合は作成
7. MapScreen に自動遷移

### 12.3 セッション管理

**初期化** (`App.tsx`):
```typescript
useEffect(() => {
  const initAuth = async () => {
    await initializeAuth();
  };
  initAuth();
}, [initializeAuth]);
```

**セッション監視**:
```typescript
supabase.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN') {
    setSession(session);
    setUser(session.user);
  } else if (event === 'SIGNED_OUT') {
    setSession(null);
    setUser(null);
  }
});
```

**セッション検証**:
```typescript
// レビュー投稿前など
const session = await supabase.auth.getSession();
if (!session.data.session) {
  Alert.alert('ログインが必要です', 'レビューを投稿するにはログインしてください。');
  return;
}
```

### 12.4 プロフィール作成（重複回避）
```typescript
async createProfileSafely(userId: string, displayName: string) {
  const { error } = await supabase
    .from('user_profiles')
    .upsert({
      id: userId,
      display_name: displayName,
    }, {
      onConflict: 'id',  // 重複時は更新
    });

  return { error };
}
```

---

## 13. ユーザー投稿機能（クラウドソーシング）

### 13.1 投稿フロー
1. **ユーザー**: 駐車場の看板写真を撮影/選択
2. **アプリ**: 画像を Supabase Storage にアップロード
3. **Edge Function**: 画像をダウンロード → Gemini API でOCR
4. **Gemini API**: 料金構造を正規化 → JSON返却
5. **Edge Function**: 信頼度スコア計算 → `parking_submissions` テーブルに保存
6. **管理者**: `AdminSubmissionsScreen` で承認・却下・編集
7. **承認時**: `parking_spots` テーブルに挿入（または既存データを更新）

### 13.2 OCR抽出項目
- **name**: 駐車場名
- **address**: 住所
- **latitude**: 緯度
- **longitude**: 経度
- **capacity**: 収容台数
- **rates**: 料金配列
  - type, minutes, price, apply_after, time_range
- **hours**: 営業時間
  - is_24h, hours
- **nearest_convenience_store**: 最寄りのコンビニ
- **nearest_hot_spring**: 最寄りの温泉

### 13.3 信頼度スコア計算
```typescript
let score = 0;
const fields = ['name', 'address', 'latitude', 'longitude', 'rates'];
const filledFields = fields.filter(f => extractedData[f] != null).length;
score = filledFields / fields.length;

// 0.0 ～ 1.0
```

**推奨**: 0.85以上は自動承認可能

### 13.4 管理画面の機能
1. **投稿リスト表示**: 信頼度スコア順
2. **画像プレビュー**: 拡大表示
3. **JSON編集**: リアルタイムバリデーション
4. **重複チェック**: 座標・名前で検出
5. **承認/更新**: ダイアログで選択
6. **却下**: ステータス変更のみ

---

## 14. 環境変数と設定

### 14.1 .env ファイル
```bash
EXPO_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...
```

### 14.2 app.json
```json
{
  "expo": {
    "name": "車旅コンシェルジュ",
    "slug": "car-concierge-app",
    "version": "1.0.0",
    "owner": "hiroakiyasa",
    "ios": {
      "bundleIdentifier": "com.carconciege.app",
      "supportsTablet": true,
      "infoPlist": {
        "NSLocationWhenInUseUsageDescription": "現在地を地図に表示するため",
        "NSCameraUsageDescription": "駐車場の写真を投稿するため",
        "NSPhotoLibraryUsageDescription": "駐車場の写真を選択するため"
      }
    },
    "android": {
      "package": "com.carconciege.app",
      "permissions": [
        "ACCESS_FINE_LOCATION",
        "ACCESS_COARSE_LOCATION",
        "CAMERA",
        "READ_EXTERNAL_STORAGE",
        "WRITE_EXTERNAL_STORAGE"
      ]
    },
    "plugins": [
      [
        "expo-image-picker",
        {
          "photosPermission": "駐車場の写真を選択するため"
        }
      ],
      [
        "expo-location",
        {
          "locationAlwaysAndWhenInUsePermission": "現在地を地図に表示するため"
        }
      ]
    ]
  }
}
```

### 14.3 EAS Build 設定
```json
{
  "cli": {
    "version": ">= 5.2.0"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal"
    },
    "preview": {
      "distribution": "internal"
    },
    "production": {}
  },
  "submit": {
    "production": {}
  }
}
```

---

## 15. ビルドとデプロイ

### 15.1 開発環境の起動
```bash
cd car-concierge-app
npm install
npx pod-install  # iOS only
npm start
```

### 15.2 iOS シミュレータ
```bash
npm run ios
```

### 15.3 Android エミュレータ
```bash
npm run android
```

### 15.4 Web ブラウザ
```bash
npm run web
```

### 15.5 プロダクションビルド
```bash
# iOS
eas build --platform ios --profile production

# Android
eas build --platform android --profile production
```

### 15.6 アプリストア提出
```bash
# iOS
eas submit --platform ios

# Android
eas submit --platform android
```

### 15.7 Edge Function デプロイ
```bash
cd supabase/functions
npx supabase functions deploy process-parking-image
npx supabase secrets set GEMINI_API_KEY="your_api_key"
```

---

## 付録A: 主要コンポーネント一覧

| コンポーネント名 | ファイルパス | 役割 |
|-----------------|------------|------|
| MapScreen | src/screens/MapScreen.tsx | メイン地図画面 |
| CompactBottomPanel | src/components/CompactBottomPanel.tsx | フィルタパネル |
| CategoryButtons | src/components/CategoryButtons.tsx | カテゴリ選択 |
| RankingListModal | src/screens/RankingListModal.tsx | ランキングモーダル |
| SpotDetailBottomSheet | src/screens/SpotDetailBottomSheet.tsx | 詳細ボトムシート |
| CustomMarker | src/components/CustomMarker.tsx | 地図マーカー |
| LoginScreen | src/screens/auth/LoginScreen.tsx | ログイン画面 |
| SignUpScreen | src/screens/auth/SignUpScreen.tsx | 新規登録画面 |
| AddParkingScreen | src/screens/AddParkingScreen.tsx | 駐車場投稿画面 |
| AdminSubmissionsScreen | src/screens/AdminSubmissionsScreen.tsx | 投稿管理画面 |
| ProfileScreen | src/screens/ProfileScreen.tsx | プロフィール画面 |
| FavoritesScreen | src/screens/FavoritesScreen.tsx | お気に入り画面 |
| MyReviewsScreen | src/screens/MyReviewsScreen.tsx | マイレビュー画面 |

---

## 付録B: サービス一覧

| サービス名 | ファイルパス | 役割 |
|----------|------------|------|
| SupabaseService | src/services/supabase.service.ts | データ取得 |
| SearchService | src/services/search.service.ts | 検索・フィルタ |
| ParkingFeeCalculator | src/services/parking-fee.service.ts | 料金計算 |
| LocationService | src/services/location.service.ts | GPS位置情報 |
| AuthService | src/services/auth.service.ts | 認証 |
| ReviewService | src/services/review.service.ts | レビュー |
| FavoritesService | src/services/favorites.service.ts | お気に入り |

---

## 付録C: データベーステーブル一覧

| テーブル名 | 主要フィールド | 行数目安 |
|----------|--------------|---------|
| parking_spots | id, name, lat, lng, rates, hours, parking_type | 50,000+ |
| convenience_stores | id, name, lat, lng, brand | 20,000+ |
| hot_springs | id, name, lat, lng, price | 5,000+ |
| gas_stations | id, name, lat, lng, brand | 10,000+ |
| festivals | id, name, lat, lng, event_date | 1,000+ |
| user_profiles | id, display_name | ユーザー数 |
| parking_reviews | id, parking_spot_id, user_id, content, rating | レビュー数 |
| hot_spring_reviews | id, hot_spring_id, user_id, content, rating | レビュー数 |
| favorites | id, user_id, parking_spot_id | お気に入り数 |
| parking_submissions | id, user_id, image_url, extracted_data | 投稿数 |

---

## 付録D: 主要な型定義

すべての型定義は `src/types/index.ts` に集約されています。

**エクスポートされる型**:
- `Spot` (基本スポット)
- `CoinParking` (駐車場)
- `ConvenienceStore` (コンビニ)
- `HotSpring` (温泉)
- `GasStation` (ガソリンスタンド)
- `Festival` (お祭り)
- `ParkingRate` (料金構造)
- `HoursInfo` (営業時間)
- `SearchFilter` (検索フィルタ)
- `Region` (地図範囲)
- `Location` (位置情報)
- `MainStore` (メイン状態)

---

## まとめ

この仕様書は、**車旅コンシェルジュ（CAR Concierge）** アプリケーションの全機能を再現するために必要なすべての情報を網羅しています。

**主要な技術的特徴**:
1. React Native/Expo による iOS/Android/Web 対応
2. Supabase によるバックエンド（PostgreSQL + Edge Functions + Storage）
3. 複雑な駐車料金計算（基本・累進・最大・時間帯別・24時間超対応）
4. Gemini API による駐車場看板のOCR自動解析
5. リアルタイムGPS位置追跡
6. 二段階タップUI、モーダルスタック制限への対応
7. 標高・周辺施設・駐車場タイプによる多層フィルタリング

**ドキュメントの使い方**:
- 新規開発時: セクション1～3でアーキテクチャを理解
- 画面実装時: セクション5で画面詳細を参照
- データベース設計時: セクション8でスキーマを参照
- API実装時: セクション6でサービス層を参照
- 料金計算実装時: セクション10でアルゴリズムを参照

このドキュメントを基に、完全な機能を持つアプリケーションを再構築可能です。
