# ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ã„ã„ã­æ©Ÿèƒ½ æœ€çµ‚è¦ä»¶å®šç¾©æ›¸

## 1. æ¦‚è¦

è»Šæ—…ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã«ä¼šå“¡ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã€å„åœ°åŸŸãƒšãƒ¼ã‚¸ã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ©Ÿèƒ½ã€ãŠã‚ˆã³åœ°åŸŸãƒ»é§è»Šå ´ãƒ»ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã«ã„ã„ã­æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

### æ©Ÿèƒ½ã®å¯¾è±¡ç¯„å›²

| æ©Ÿèƒ½ | åœ°åŸŸãƒšãƒ¼ã‚¸ | é§è»Šå ´ã‚«ãƒ¼ãƒ‰ | ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰ |
|------|-----------|-------------|----------------|
| **ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿** | âœ… ä¼šå“¡ã®ã¿ | âŒ | âŒ |
| **ã„ã„ã­** | âœ… èª°ã§ã‚‚ | âœ… èª°ã§ã‚‚ | âœ… èª°ã§ã‚‚ |
| **ã„ã„ã­æ•°è¡¨ç¤º** | âœ… | âœ… | âœ… |

### ä¸»è¦æ©Ÿèƒ½
- âœ… **ä¼šå“¡ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³**ï¼ˆãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ + Google OAuthï¼‰
- âœ… **ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿**ï¼ˆåœ°åŸŸãƒšãƒ¼ã‚¸ã®ã¿ã€ä¼šå“¡é™å®šï¼‰
- âœ… **ã„ã„ã­æ©Ÿèƒ½**ï¼ˆåœ°åŸŸãƒ»é§è»Šå ´ãƒ»ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã€èª°ã§ã‚‚å¯èƒ½ï¼‰
- âœ… **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ©Ÿèƒ½**ï¼ˆè‡ªå·±ç´¹ä»‹ã€ã‚¢ãƒã‚¿ãƒ¼ç”»åƒï¼‰
- âœ… **ãƒã‚¤ãƒšãƒ¼ã‚¸**ï¼ˆæŠ•ç¨¿å±¥æ­´ã€ã„ã„ã­å±¥æ­´ï¼‰

---

## 2. æ©Ÿèƒ½è¦ä»¶ã®è©³ç´°

### 2.1 ã„ã„ã­æ©Ÿèƒ½ï¼ˆèª°ã§ã‚‚å¯èƒ½ã€ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰

#### å¯¾è±¡
1. **åœ°åŸŸãƒšãƒ¼ã‚¸å…¨ä½“ã¸ã®ã„ã„ã­**
   - 808å€‹ã®åœ°åŸŸãƒšãƒ¼ã‚¸ï¼ˆä¾‹: éŠ€åº§.htmlã€æ–°å®¿è¥¿å£.htmlï¼‰
   - ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«ã„ã„ã­ãƒœã‚¿ãƒ³é…ç½®
   - ã€Œã“ã®åœ°åŸŸãŒå¥½ãã€ã¨ã„ã†æ„å‘³

2. **é§è»Šå ´ã‚«ãƒ¼ãƒ‰ã¸ã®ã„ã„ã­**
   - åœ°åŸŸãƒšãƒ¼ã‚¸å†…ã«è¡¨ç¤ºã•ã‚Œã‚‹å„é§è»Šå ´ã‚«ãƒ¼ãƒ‰
   - ã‚«ãƒ¼ãƒ‰å†…ã«ã„ã„ã­ãƒœã‚¿ãƒ³é…ç½®
   - ã€Œã“ã®é§è»Šå ´ãŒãŠã™ã™ã‚ã€ã¨ã„ã†æ„å‘³

3. **ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰ã¸ã®ã„ã„ã­**
   - åœ°åŸŸãƒšãƒ¼ã‚¸å†…ã«è¡¨ç¤ºã•ã‚Œã‚‹å„ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰
   - ã‚«ãƒ¼ãƒ‰å†…ã«ã„ã„ã­ãƒœã‚¿ãƒ³é…ç½®
   - ã€Œã“ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã«è¡ŒããŸã„ã€ã¨ã„ã†æ„å‘³

#### åŸºæœ¬æ©Ÿèƒ½
- âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã§èª°ã§ã‚‚ã„ã„ã­å¯èƒ½
- âœ… 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1å›ã¾ã§ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
- âœ… ã„ã„ã­ã®å–ã‚Šæ¶ˆã—å¯èƒ½
- âœ… ã„ã„ã­æ•°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
- âœ… ãƒ–ãƒ©ã‚¦ã‚¶ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ + Cookie ã§é‡è¤‡é˜²æ­¢

#### ä¼šå“¡ã¨ã„ã„ã­ã®é•ã„
| é …ç›® | éä¼šå“¡ | ä¼šå“¡ |
|------|--------|------|
| ã„ã„ã­å¯èƒ½ | âœ… | âœ… |
| ã„ã„ã­å±¥æ­´ä¿å­˜ | Cookieï¼ˆ30æ—¥ï¼‰ | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æ°¸ä¹…ä¿å­˜ |
| è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹åŒæœŸ | âŒ | âœ… |
| ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ç¢ºèª | âŒ | âœ… |
| ã„ã„ã­è§£é™¤ | âœ… | âœ… |

### 2.2 ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ï¼ˆåœ°åŸŸãƒšãƒ¼ã‚¸ã®ã¿ã€ä¼šå“¡é™å®šï¼‰

#### æŠ•ç¨¿å¯¾è±¡
- âœ… **åœ°åŸŸãƒšãƒ¼ã‚¸ã®ã¿**ï¼ˆ808ç®‡æ‰€ï¼‰
- âŒ é§è»Šå ´ãƒšãƒ¼ã‚¸ï¼ˆæŠ•ç¨¿æ©Ÿèƒ½ãªã—ï¼‰
- âŒ ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆæŠ•ç¨¿æ©Ÿèƒ½ãªã—ï¼‰

#### åŸºæœ¬æ©Ÿèƒ½
- âœ… **ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿**: ä¼šå“¡ã®ã¿
- âœ… **è¿”ä¿¡æ©Ÿèƒ½**: ã‚³ãƒ¡ãƒ³ãƒˆã¸ã®è¿”ä¿¡ï¼ˆ1éšå±¤ã®ã¿ï¼‰
- âœ… **ç·¨é›†ãƒ»å‰Šé™¤**: è‡ªåˆ†ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿
- âœ… **ã‚³ãƒ¡ãƒ³ãƒˆã¸ã®ã„ã„ã­**: èª°ã§ã‚‚å¯èƒ½
- âœ… **è©•ä¾¡ã‚¹ã‚³ã‚¢**: 1-5ã¤æ˜Ÿï¼ˆåœ°åŸŸå…¨ä½“ã®è©•ä¾¡ï¼‰
- âœ… **ã‚¹ãƒ‘ãƒ å ±å‘Š**: ä¸é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆå ±å‘Š

#### ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›é …ç›®
- **ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡**: å¿…é ˆï¼ˆ1-1000æ–‡å­—ï¼‰
- **è©•ä¾¡**: ä»»æ„ï¼ˆ1-5ã¤æ˜Ÿï¼‰
- **ç”»åƒ**: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå°†æ¥å®Ÿè£…ã€æœ€å¤§3æšï¼‰

#### ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
- **ã‚½ãƒ¼ãƒˆ**: æ–°ç€é † / äººæ°—é †ï¼ˆã„ã„ã­æ•°ï¼‰/ è©•ä¾¡é †
- **ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**: æ˜Ÿè©•ä¾¡ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**: 20ä»¶ãšã¤è¡¨ç¤º

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆSupabaseï¼‰

### 3.1 ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

#### `profiles` ãƒ†ãƒ¼ãƒ–ãƒ«
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,

  -- åŸºæœ¬æƒ…å ±
  username TEXT UNIQUE NOT NULL CHECK (char_length(username) >= 3 AND char_length(username) <= 20),
  display_name TEXT CHECK (char_length(display_name) >= 3 AND char_length(display_name) <= 30),
  avatar_url TEXT,
  bio TEXT CHECK (char_length(bio) <= 500),

  -- è©³ç´°æƒ…å ±
  prefecture TEXT,
  website_url TEXT,
  twitter_url TEXT,
  instagram_url TEXT,

  -- çµ±è¨ˆæƒ…å ±ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  comments_count INTEGER DEFAULT 0,
  likes_given INTEGER DEFAULT 0,        -- ã„ã„ã­ã—ãŸæ•°
  likes_received INTEGER DEFAULT 0,     -- ç²å¾—ã„ã„ã­æ•°

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_profiles_username ON profiles(username);
CREATE INDEX idx_profiles_created ON profiles(created_at DESC);
```

#### `regions` ãƒ†ãƒ¼ãƒ–ãƒ«
åœ°åŸŸãƒã‚¹ã‚¿

```sql
CREATE TABLE regions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,             -- URLã‚¹ãƒ©ãƒƒã‚°ï¼ˆä¾‹: ginzaï¼‰
  name TEXT NOT NULL,                    -- åœ°åŸŸåï¼ˆä¾‹: éŠ€åº§ï¼‰
  lat DECIMAL(10, 8) NOT NULL,
  lng DECIMAL(11, 8) NOT NULL,
  elevation INTEGER DEFAULT 0,
  restaurant_count INTEGER DEFAULT 0,

  -- çµ±è¨ˆæƒ…å ±ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  likes_count INTEGER DEFAULT 0,         -- åœ°åŸŸã¸ã®ã„ã„ã­æ•°
  comments_count INTEGER DEFAULT 0,      -- ã‚³ãƒ¡ãƒ³ãƒˆæ•°
  avg_rating DECIMAL(3, 2),              -- å¹³å‡è©•ä¾¡

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_regions_slug ON regions(slug);
CREATE INDEX idx_regions_likes ON regions(likes_count DESC);
```

#### `parking_spots` ãƒ†ãƒ¼ãƒ–ãƒ«
é§è»Šå ´ãƒã‚¹ã‚¿

```sql
CREATE TABLE parking_spots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  region_slug TEXT NOT NULL,             -- æ‰€å±åœ°åŸŸ
  name TEXT NOT NULL,                    -- é§è»Šå ´å
  lat DECIMAL(10, 8) NOT NULL,
  lng DECIMAL(11, 8) NOT NULL,

  -- æ–™é‡‘æƒ…å ±
  overnight_fee INTEGER,                 -- è»Šä¸­æ³Šæ–™é‡‘ï¼ˆæ¦‚ç®—ï¼‰
  max_rate_24h INTEGER,
  night_rate INTEGER,
  rate_per_hour INTEGER,

  -- çµ±è¨ˆæƒ…å ±
  likes_count INTEGER DEFAULT 0,         -- ã„ã„ã­æ•°

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_parking_spots_region ON parking_spots(region_slug);
CREATE INDEX idx_parking_spots_likes ON parking_spots(likes_count DESC);
```

#### `restaurants` ãƒ†ãƒ¼ãƒ–ãƒ«
ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒã‚¹ã‚¿

```sql
CREATE TABLE restaurants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  region_slug TEXT NOT NULL,             -- æ‰€å±åœ°åŸŸ
  name TEXT NOT NULL,                    -- ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å
  lat DECIMAL(10, 8) NOT NULL,
  lng DECIMAL(11, 8) NOT NULL,

  -- Tabelogæƒ…å ±
  score DECIMAL(3, 2),                   -- ã‚¹ã‚³ã‚¢ï¼ˆä¾‹: 4.71ï¼‰
  genre TEXT,                            -- ã‚¸ãƒ£ãƒ³ãƒ«
  address TEXT,
  dinner_budget TEXT,

  -- çµ±è¨ˆæƒ…å ±
  likes_count INTEGER DEFAULT 0,         -- ã„ã„ã­æ•°

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_restaurants_region ON restaurants(region_slug);
CREATE INDEX idx_restaurants_score ON restaurants(score DESC);
CREATE INDEX idx_restaurants_likes ON restaurants(likes_count DESC);
```

#### `likes` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆçµ±åˆç‰ˆï¼‰
åœ°åŸŸãƒ»é§è»Šå ´ãƒ»ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã™ã¹ã¦ã®ã„ã„ã­ã‚’ç®¡ç†

```sql
CREATE TABLE likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ã„ã„ã­å¯¾è±¡ï¼ˆã„ãšã‚Œã‹1ã¤ï¼‰
  target_type TEXT NOT NULL CHECK (target_type IN ('region', 'parking_spot', 'restaurant', 'comment')),
  target_id UUID NOT NULL,               -- å¯¾è±¡ã®IDï¼ˆregion_id, parking_spot_id, etc.ï¼‰

  -- ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ï¼ˆã©ã¡ã‚‰ã‹å¿…é ˆï¼‰
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,      -- ä¼šå“¡ã®å ´åˆ
  user_fingerprint TEXT,                 -- éä¼šå“¡ã®å ´åˆ

  ip_address INET,
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- åˆ¶ç´„: 1å¯¾è±¡ã«ã¤ã1ãƒ¦ãƒ¼ã‚¶ãƒ¼1ã„ã„ã­ã¾ã§
  CONSTRAINT unique_like UNIQUE NULLS NOT DISTINCT (target_type, target_id, user_id, user_fingerprint)
);

CREATE INDEX idx_likes_target ON likes(target_type, target_id);
CREATE INDEX idx_likes_user ON likes(user_id);
CREATE INDEX idx_likes_fingerprint ON likes(user_fingerprint);
CREATE INDEX idx_likes_created ON likes(created_at DESC);
```

#### `comments` ãƒ†ãƒ¼ãƒ–ãƒ«
ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆåœ°åŸŸãƒšãƒ¼ã‚¸ã®ã¿ï¼‰

```sql
CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  region_slug TEXT NOT NULL,             -- åœ°åŸŸã‚¹ãƒ©ãƒƒã‚°ï¼ˆåœ°åŸŸãƒšãƒ¼ã‚¸ã®ã¿ï¼‰
  parent_id UUID REFERENCES comments(id) ON DELETE CASCADE,

  -- æŠ•ç¨¿è€…ï¼ˆå¿…é ˆ: ä¼šå“¡ã®ã¿ï¼‰
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

  -- ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹
  content TEXT NOT NULL CHECK (char_length(content) >= 1 AND char_length(content) <= 1000),
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),

  -- çµ±è¨ˆæƒ…å ±
  likes_count INTEGER DEFAULT 0,
  replies_count INTEGER DEFAULT 0,

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT DEFAULT 'approved' CHECK (status IN ('approved', 'rejected', 'spam')),
  is_edited BOOLEAN DEFAULT FALSE,
  edited_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_comments_region ON comments(region_slug);
CREATE INDEX idx_comments_user ON comments(user_id);
CREATE INDEX idx_comments_parent ON comments(parent_id);
CREATE INDEX idx_comments_likes ON comments(likes_count DESC);
CREATE INDEX idx_comments_rating ON comments(rating DESC);
```

### 3.2 Row Level Security (RLS)

#### `likes` ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLS

```sql
ALTER TABLE likes ENABLE ROW LEVEL SECURITY;

-- èª°ã§ã‚‚é–²è¦§å¯èƒ½
CREATE POLICY "Anyone can view likes"
  ON likes FOR SELECT
  USING (true);

-- èª°ã§ã‚‚ã„ã„ã­è¿½åŠ å¯èƒ½
CREATE POLICY "Anyone can add likes"
  ON likes FOR INSERT
  WITH CHECK (true);

-- è‡ªåˆ†ã®ã„ã„ã­ã®ã¿å‰Šé™¤å¯èƒ½ï¼ˆä¼šå“¡ï¼‰
CREATE POLICY "Users can delete own likes"
  ON likes FOR DELETE
  USING (auth.uid() = user_id OR user_id IS NULL);
```

#### `parking_spots` ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLS

```sql
ALTER TABLE parking_spots ENABLE ROW LEVEL SECURITY;

-- èª°ã§ã‚‚é–²è¦§å¯èƒ½
CREATE POLICY "Anyone can view parking spots"
  ON parking_spots FOR SELECT
  USING (true);

-- ç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½
CREATE POLICY "Only admins can modify parking spots"
  ON parking_spots FOR ALL
  USING (auth.role() = 'admin');
```

#### `restaurants` ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLS

```sql
ALTER TABLE restaurants ENABLE ROW LEVEL SECURITY;

-- èª°ã§ã‚‚é–²è¦§å¯èƒ½
CREATE POLICY "Anyone can view restaurants"
  ON restaurants FOR SELECT
  USING (true);

-- ç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½
CREATE POLICY "Only admins can modify restaurants"
  ON restaurants FOR ALL
  USING (auth.role() = 'admin');
```

### 3.3 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°

#### ã„ã„ã­æ•°ã‚’å–å¾—ï¼ˆå¯¾è±¡åˆ¥ï¼‰

```sql
CREATE OR REPLACE FUNCTION get_likes_count(
  target_type_param TEXT,
  target_id_param UUID
)
RETURNS INTEGER AS $$
  SELECT COUNT(*)::INTEGER FROM likes
  WHERE target_type = target_type_param
  AND target_id = target_id_param;
$$ LANGUAGE SQL STABLE;
```

#### ã„ã„ã­çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«ã„ã„ã­æ¸ˆã¿ã‹ï¼‰

```sql
CREATE OR REPLACE FUNCTION check_user_liked(
  target_type_param TEXT,
  target_id_param UUID,
  user_id_param UUID,
  fingerprint_param TEXT
)
RETURNS BOOLEAN AS $$
  SELECT EXISTS(
    SELECT 1 FROM likes
    WHERE target_type = target_type_param
    AND target_id = target_id_param
    AND (
      (user_id_param IS NOT NULL AND user_id = user_id_param)
      OR
      (fingerprint_param IS NOT NULL AND user_fingerprint = fingerprint_param)
    )
  );
$$ LANGUAGE SQL STABLE;
```

#### é§è»Šå ´ä¸€è¦§ã‚’å–å¾—ï¼ˆã„ã„ã­æ•°å«ã‚€ï¼‰

```sql
CREATE OR REPLACE FUNCTION get_parking_spots_with_likes(
  region_slug_param TEXT,
  user_id_param UUID DEFAULT NULL,
  fingerprint_param TEXT DEFAULT NULL
)
RETURNS TABLE (
  id UUID,
  name TEXT,
  lat DECIMAL,
  lng DECIMAL,
  overnight_fee INTEGER,
  likes_count INTEGER,
  user_liked BOOLEAN
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    ps.id,
    ps.name,
    ps.lat,
    ps.lng,
    ps.overnight_fee,
    ps.likes_count,
    EXISTS(
      SELECT 1 FROM likes l
      WHERE l.target_type = 'parking_spot'
      AND l.target_id = ps.id
      AND (
        (user_id_param IS NOT NULL AND l.user_id = user_id_param)
        OR
        (fingerprint_param IS NOT NULL AND l.user_fingerprint = fingerprint_param)
      )
    ) AS user_liked
  FROM parking_spots ps
  WHERE ps.region_slug = region_slug_param
  ORDER BY ps.overnight_fee ASC NULLS LAST;
END;
$$ LANGUAGE plpgsql STABLE;
```

#### ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ä¸€è¦§ã‚’å–å¾—ï¼ˆã„ã„ã­æ•°å«ã‚€ï¼‰

```sql
CREATE OR REPLACE FUNCTION get_restaurants_with_likes(
  region_slug_param TEXT,
  user_id_param UUID DEFAULT NULL,
  fingerprint_param TEXT DEFAULT NULL
)
RETURNS TABLE (
  id UUID,
  name TEXT,
  score DECIMAL,
  genre TEXT,
  address TEXT,
  likes_count INTEGER,
  user_liked BOOLEAN
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    r.id,
    r.name,
    r.score,
    r.genre,
    r.address,
    r.likes_count,
    EXISTS(
      SELECT 1 FROM likes l
      WHERE l.target_type = 'restaurant'
      AND l.target_id = r.id
      AND (
        (user_id_param IS NOT NULL AND l.user_id = user_id_param)
        OR
        (fingerprint_param IS NOT NULL AND l.user_fingerprint = fingerprint_param)
      )
    ) AS user_liked
  FROM restaurants r
  WHERE r.region_slug = region_slug_param
  ORDER BY r.score DESC NULLS LAST;
END;
$$ LANGUAGE plpgsql STABLE;
```

#### ãƒˆãƒªã‚¬ãƒ¼: ã„ã„ã­æ•°ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°

```sql
-- ã„ã„ã­è¿½åŠ æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
CREATE OR REPLACE FUNCTION update_likes_count_on_insert()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.target_type = 'region' THEN
    UPDATE regions SET likes_count = likes_count + 1 WHERE id = NEW.target_id;
  ELSIF NEW.target_type = 'parking_spot' THEN
    UPDATE parking_spots SET likes_count = likes_count + 1 WHERE id = NEW.target_id;
  ELSIF NEW.target_type = 'restaurant' THEN
    UPDATE restaurants SET likes_count = likes_count + 1 WHERE id = NEW.target_id;
  ELSIF NEW.target_type = 'comment' THEN
    UPDATE comments SET likes_count = likes_count + 1 WHERE id = NEW.target_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER likes_insert_trigger
  AFTER INSERT ON likes
  FOR EACH ROW EXECUTE FUNCTION update_likes_count_on_insert();

-- ã„ã„ã­å‰Šé™¤æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
CREATE OR REPLACE FUNCTION update_likes_count_on_delete()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.target_type = 'region' THEN
    UPDATE regions SET likes_count = GREATEST(0, likes_count - 1) WHERE id = OLD.target_id;
  ELSIF OLD.target_type = 'parking_spot' THEN
    UPDATE parking_spots SET likes_count = GREATEST(0, likes_count - 1) WHERE id = OLD.target_id;
  ELSIF OLD.target_type = 'restaurant' THEN
    UPDATE restaurants SET likes_count = GREATEST(0, likes_count - 1) WHERE id = OLD.target_id;
  ELSIF OLD.target_type = 'comment' THEN
    UPDATE comments SET likes_count = GREATEST(0, likes_count - 1) WHERE id = OLD.target_id;
  END IF;
  RETURN OLD;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER likes_delete_trigger
  AFTER DELETE ON likes
  FOR EACH ROW EXECUTE FUNCTION update_likes_count_on_delete();
```

---

## 4. APIè¨­è¨ˆ

### 4.1 ã„ã„ã­APIï¼ˆåœ°åŸŸãƒ»é§è»Šå ´ãƒ»ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å…±é€šï¼‰

#### ã„ã„ã­ã‚’è¿½åŠ 

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/likes`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "target_type": "parking_spot",        // 'region', 'parking_spot', 'restaurant', 'comment'
  "target_id": "uuid-here",
  "user_id": "uuid-here",               // ä¼šå“¡ã®å ´åˆï¼ˆä»»æ„ï¼‰
  "fingerprint": "abc123xyz789"         // éä¼šå“¡ã®å ´åˆï¼ˆä»»æ„ï¼‰
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "likes_count": 125
}
```

#### ã„ã„ã­ã‚’å‰Šé™¤

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `DELETE /api/likes`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "target_type": "parking_spot",
  "target_id": "uuid-here",
  "user_id": "uuid-here",               // ã¾ãŸã¯
  "fingerprint": "abc123xyz789"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "likes_count": 124
}
```

#### ã„ã„ã­æ•°ã‚’å–å¾—

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/likes/:type/:id/count`

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "count": 124
}
```

### 4.2 é§è»Šå ´ãƒ»ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å–å¾—API

#### é§è»Šå ´ä¸€è¦§ï¼ˆã„ã„ã­æƒ…å ±å«ã‚€ï¼‰

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´**:
```javascript
const { data: parkingSpots } = await supabase
  .rpc('get_parking_spots_with_likes', {
    region_slug_param: 'ginza',
    user_id_param: currentUser?.id || null,
    fingerprint_param: userFingerprint
  });
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
[
  {
    "id": "uuid-1",
    "name": "ã‚¿ã‚¤ãƒ ã‚ºéŠ€åº§",
    "overnight_fee": 1500,
    "likes_count": 24,
    "user_liked": true
  },
  {
    "id": "uuid-2",
    "name": "ä¸‰äº•ã®ãƒªãƒ‘ãƒ¼ã‚¯éŠ€åº§",
    "overnight_fee": 2000,
    "likes_count": 18,
    "user_liked": false
  }
]
```

#### ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ä¸€è¦§ï¼ˆã„ã„ã­æƒ…å ±å«ã‚€ï¼‰

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´**:
```javascript
const { data: restaurants } = await supabase
  .rpc('get_restaurants_with_likes', {
    region_slug_param: 'ginza',
    user_id_param: currentUser?.id || null,
    fingerprint_param: userFingerprint
  });
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
[
  {
    "id": "uuid-1",
    "name": "ã™ãã‚„ã°ã—æ¬¡éƒ",
    "score": 4.71,
    "genre": "å¯¿å¸",
    "address": "æ±äº¬éƒ½ä¸­å¤®åŒºéŠ€åº§...",
    "likes_count": 156,
    "user_liked": false
  }
]
```

---

## 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

### 5.1 UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### åœ°åŸŸãƒšãƒ¼ã‚¸ã®ã„ã„ã­ãƒœã‚¿ãƒ³ï¼ˆãƒšãƒ¼ã‚¸ä¸Šéƒ¨ï¼‰

```html
<div class="region-header">
  <h1>ğŸš— éŠ€åº§ã®è»Šä¸­æ³Šã‚¹ãƒãƒƒãƒˆ</h1>

  <div class="region-stats">
    <div class="stat-item">
      <span class="stat-label">é§è»Šå ´</span>
      <span class="stat-value" id="parking-count">12</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³</span>
      <span class="stat-value" id="restaurant-count">150</span>
    </div>
  </div>

  <!-- åœ°åŸŸã¸ã®ã„ã„ã­ãƒœã‚¿ãƒ³ -->
  <div class="region-like">
    <button id="region-like-btn" class="like-button" onclick="toggleRegionLike()">
      <svg class="heart-icon" viewBox="0 0 24 24">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
    </button>
    <span id="region-like-count">124</span>
  </div>
</div>
```

#### é§è»Šå ´ã‚«ãƒ¼ãƒ‰ï¼ˆã„ã„ã­ãƒœã‚¿ãƒ³ä»˜ãï¼‰

```html
<div class="parking-card" data-parking-id="uuid-1">
  <div class="parking-header">
    <h3 class="parking-name">ã‚¿ã‚¤ãƒ ã‚ºéŠ€åº§</h3>
    <div class="parking-like">
      <button class="like-button-small" onclick="toggleParkingLike('uuid-1')">
        <svg class="heart-icon-small" viewBox="0 0 24 24">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
        <span class="like-count">24</span>
      </button>
    </div>
  </div>

  <div class="parking-body">
    <div class="parking-fee">
      <span class="fee-label">è»Šä¸­æ³Šæ–™é‡‘</span>
      <span class="fee-value">Â¥1,500</span>
    </div>
    <div class="parking-info">
      <p>ğŸ“ æ±äº¬éƒ½ä¸­å¤®åŒºéŠ€åº§...</p>
      <p>ğŸ•’ 24æ™‚é–“å–¶æ¥­</p>
    </div>
  </div>

  <div class="parking-footer">
    <a href="#" class="btn-map">åœ°å›³ã§è¦‹ã‚‹</a>
  </div>
</div>
```

#### ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰ï¼ˆã„ã„ã­ãƒœã‚¿ãƒ³ä»˜ãï¼‰

```html
<div class="restaurant-card" data-restaurant-id="uuid-1">
  <div class="restaurant-header">
    <div class="restaurant-info">
      <h3 class="restaurant-name">ã™ãã‚„ã°ã—æ¬¡éƒ</h3>
      <div class="restaurant-meta">
        <span class="score">â­ 4.71</span>
        <span class="genre">å¯¿å¸</span>
      </div>
    </div>
    <div class="restaurant-like">
      <button class="like-button-small" onclick="toggleRestaurantLike('uuid-1')">
        <svg class="heart-icon-small" viewBox="0 0 24 24">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
        <span class="like-count">156</span>
      </button>
    </div>
  </div>

  <div class="restaurant-body">
    <p class="address">ğŸ“ æ±äº¬éƒ½ä¸­å¤®åŒºéŠ€åº§4-2-15</p>
    <p class="budget">ğŸ’° Â¥40,000ï½Â¥49,999</p>
  </div>

  <div class="restaurant-footer">
    <a href="#" class="btn-tabelog" target="_blank">é£Ÿã¹ãƒ­ã‚°ã§è¦‹ã‚‹</a>
    <a href="#" class="btn-map">åœ°å›³ã§è¦‹ã‚‹</a>
  </div>
</div>
```

#### ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåœ°åŸŸãƒšãƒ¼ã‚¸ã®ã¿ï¼‰

```html
<div class="comments-section">
  <h2>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ (<span id="comment-count">156</span>)</h2>

  <!-- ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¼šå“¡ã®ã¿ï¼‰ -->
  <div id="comment-form-container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ -->
    <div id="comment-form-logged-in" style="display: none;">
      <h3>ã“ã®åœ°åŸŸã®æ„Ÿæƒ³ã‚’æŠ•ç¨¿</h3>
      <form id="comment-form">
        <div class="form-group">
          <label>è©•ä¾¡ï¼ˆä»»æ„ï¼‰</label>
          <div class="star-rating">
            <input type="radio" name="rating" value="5" id="star5">
            <label for="star5">â˜…</label>
            <input type="radio" name="rating" value="4" id="star4">
            <label for="star4">â˜…</label>
            <input type="radio" name="rating" value="3" id="star3">
            <label for="star3">â˜…</label>
            <input type="radio" name="rating" value="2" id="star2">
            <label for="star2">â˜…</label>
            <input type="radio" name="rating" value="1" id="star1">
            <label for="star1">â˜…</label>
          </div>
        </div>

        <div class="form-group">
          <textarea id="comment-content" required
                    maxlength="1000" rows="5"
                    placeholder="ã“ã®åœ°åŸŸã®è»Šä¸­æ³Šã‚¹ãƒãƒƒãƒˆã¨ã—ã¦ã®æ„Ÿæƒ³ã‚’æ•™ãˆã¦ãã ã•ã„..."></textarea>
          <small><span id="char-count">0</span> / 1000</small>
        </div>

        <button type="submit" class="btn-primary">æŠ•ç¨¿ã™ã‚‹</button>
      </form>
    </div>

    <!-- æœªãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="comment-form-logged-out">
      <div class="login-prompt">
        <p>ã“ã®åœ°åŸŸã«ã¤ã„ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯</p>
        <a href="/camping_note/auth/login.html" class="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</a>
        <span>ã¾ãŸã¯</span>
        <a href="/camping_note/auth/register.html" class="btn-register">æ–°è¦ç™»éŒ²</a>
      </div>
    </div>
  </div>

  <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
  <div class="comments-list" id="comments-list">
    <!-- ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¤ãƒ†ãƒ  -->
  </div>
</div>
```

### 5.2 CSSè¨­è¨ˆ

```css
/* ã„ã„ã­ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
.like-button, .like-button-small {
  background: none;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 8px;
  transition: transform 0.2s;
}

.like-button:hover, .like-button-small:hover {
  transform: scale(1.1);
}

.heart-icon, .heart-icon-small {
  fill: #ccc;
  transition: fill 0.3s;
}

.heart-icon {
  width: 32px;
  height: 32px;
}

.heart-icon-small {
  width: 20px;
  height: 20px;
}

.heart-icon.liked, .heart-icon-small.liked {
  fill: #e74c3c;
  animation: heartbeat 0.3s;
}

@keyframes heartbeat {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

.like-count {
  font-size: 14px;
  color: #666;
  font-weight: 500;
}

/* é§è»Šå ´ã‚«ãƒ¼ãƒ‰ */
.parking-card {
  background: white;
  border-radius: 8px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 16px;
}

.parking-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.parking-name {
  font-size: 1.2em;
  margin: 0;
  color: #1976d2;
}

.parking-fee {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #f5f5f5;
  border-radius: 4px;
  margin-bottom: 8px;
}

.fee-value {
  font-size: 1.5em;
  font-weight: bold;
  color: #2ecc71;
}

/* ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰ */
.restaurant-card {
  background: white;
  border-radius: 8px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 16px;
}

.restaurant-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.restaurant-name {
  font-size: 1.2em;
  margin: 0 0 4px 0;
  color: #1976d2;
}

.restaurant-meta {
  display: flex;
  gap: 12px;
  font-size: 0.9em;
}

.score {
  color: #f39c12;
  font-weight: 600;
}

.genre {
  color: #666;
}
```

### 5.3 JavaScriptå®Ÿè£…

#### ã„ã„ã­æ©Ÿèƒ½ã®å®Ÿè£…

```javascript
// likes.js - ã„ã„ã­æ©Ÿèƒ½ã®å…±é€šå‡¦ç†

// ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
let userFingerprint = null;

// ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆåˆæœŸåŒ–
async function initFingerprint() {
  const fp = await FingerprintJS.load();
  const result = await fp.get();
  userFingerprint = result.visitorId;
}

// æ±ç”¨ã„ã„ã­åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
async function toggleLike(targetType, targetId, buttonElement) {
  const heartIcon = buttonElement.querySelector('.heart-icon, .heart-icon-small');
  const likeCountElement = buttonElement.querySelector('.like-count');
  const isLiked = heartIcon.classList.contains('liked');

  try {
    if (isLiked) {
      // ã„ã„ã­å‰Šé™¤
      await supabase
        .from('likes')
        .delete()
        .eq('target_type', targetType)
        .eq('target_id', targetId)
        .eq(currentUser ? 'user_id' : 'user_fingerprint', currentUser ? currentUser.id : userFingerprint);

      heartIcon.classList.remove('liked');
    } else {
      // ã„ã„ã­è¿½åŠ 
      await supabase
        .from('likes')
        .insert({
          target_type: targetType,
          target_id: targetId,
          user_id: currentUser?.id || null,
          user_fingerprint: currentUser ? null : userFingerprint
        });

      heartIcon.classList.add('liked');
    }

    // ã„ã„ã­æ•°ã‚’å†å–å¾—
    const { data: count } = await supabase
      .rpc('get_likes_count', {
        target_type_param: targetType,
        target_id_param: targetId
      });

    likeCountElement.textContent = count || 0;

  } catch (error) {
    console.error('ã„ã„ã­ã‚¨ãƒ©ãƒ¼:', error);
    alert('ã„ã„ã­ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// åœ°åŸŸã¸ã®ã„ã„ã­
async function toggleRegionLike() {
  const regionSlug = getRegionSlug();
  const button = document.getElementById('region-like-btn');

  // region_slugã‹ã‚‰region_idã‚’å–å¾—
  const { data: region } = await supabase
    .from('regions')
    .select('id')
    .eq('slug', regionSlug)
    .single();

  if (region) {
    await toggleLike('region', region.id, button);
  }
}

// é§è»Šå ´ã¸ã®ã„ã„ã­
async function toggleParkingLike(parkingId) {
  const button = document.querySelector(`[data-parking-id="${parkingId}"] .like-button-small`);
  await toggleLike('parking_spot', parkingId, button);
}

// ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã¸ã®ã„ã„ã­
async function toggleRestaurantLike(restaurantId) {
  const button = document.querySelector(`[data-restaurant-id="${restaurantId}"] .like-button-small`);
  await toggleLike('restaurant', restaurantId, button);
}

// ã‚³ãƒ¡ãƒ³ãƒˆã¸ã®ã„ã„ã­
async function toggleCommentLike(commentId) {
  const button = document.querySelector(`[data-comment-id="${commentId}"] .comment-like-btn`);
  await toggleLike('comment', commentId, button);
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', async () => {
  await initFingerprint();
  await loadLikeStates();
});

// ã„ã„ã­çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
async function loadLikeStates() {
  const regionSlug = getRegionSlug();

  // åœ°åŸŸã®ã„ã„ã­çŠ¶æ…‹
  const { data: region } = await supabase
    .from('regions')
    .select('id, likes_count')
    .eq('slug', regionSlug)
    .single();

  if (region) {
    document.getElementById('region-like-count').textContent = region.likes_count || 0;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«ã„ã„ã­æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
    const { data: liked } = await supabase
      .rpc('check_user_liked', {
        target_type_param: 'region',
        target_id_param: region.id,
        user_id_param: currentUser?.id || null,
        fingerprint_param: userFingerprint
      });

    if (liked) {
      document.querySelector('#region-like-btn .heart-icon').classList.add('liked');
    }
  }

  // é§è»Šå ´ãƒ»ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ã„ã„ã­çŠ¶æ…‹ã‚‚åŒæ§˜ã«èª­ã¿è¾¼ã¿
  await loadParkingSpotsWithLikes();
  await loadRestaurantsWithLikes();
}

// é§è»Šå ´ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆã„ã„ã­æƒ…å ±å«ã‚€ï¼‰
async function loadParkingSpotsWithLikes() {
  const regionSlug = getRegionSlug();

  const { data: parkingSpots } = await supabase
    .rpc('get_parking_spots_with_likes', {
      region_slug_param: regionSlug,
      user_id_param: currentUser?.id || null,
      fingerprint_param: userFingerprint
    });

  renderParkingSpots(parkingSpots);
}

// ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆã„ã„ã­æƒ…å ±å«ã‚€ï¼‰
async function loadRestaurantsWithLikes() {
  const regionSlug = getRegionSlug();

  const { data: restaurants } = await supabase
    .rpc('get_restaurants_with_likes', {
      region_slug_param: regionSlug,
      user_id_param: currentUser?.id || null,
      fingerprint_param: userFingerprint
    });

  renderRestaurants(restaurants);
}
```

---

## 6. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ»åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 6.1 æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ

**ç¾çŠ¶:**
- 808å€‹ã®åœ°åŸŸHTMLãƒ•ã‚¡ã‚¤ãƒ«
- regions-data-with-elevation.jsonï¼ˆåœ°åŸŸãƒ‡ãƒ¼ã‚¿ï¼‰
- Supabase: parking_spotsãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé§è»Šå ´ãƒ‡ãƒ¼ã‚¿ï¼‰
- â˜…all-restaurants-with-ids.jsonï¼ˆ18,345ä»¶ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼‰

**ç§»è¡Œæ‰‹é †:**

#### Step 1: regionsãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

```javascript
// migrate-regions.js

const fs = require('fs');
const { createClient } = require('@supabase/supabase-js');

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

async function migrateRegions() {
  // JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  const regions = JSON.parse(
    fs.readFileSync('./data/regions-data-with-elevation.json', 'utf8')
  );

  // Supabaseã«æŒ¿å…¥
  for (const region of regions) {
    const slug = region.fileName || region.name.replace(/[\/\\:*?"<>|]/g, '_');

    await supabase
      .from('regions')
      .upsert({
        slug,
        name: region.name,
        lat: region.lat,
        lng: region.lng,
        elevation: region.elevation || 0,
        restaurant_count: region.restaurantCount || 0,
        likes_count: 0,
        comments_count: 0
      }, {
        onConflict: 'slug'
      });

    console.log(`âœ… ${region.name} ã‚’ç§»è¡Œã—ã¾ã—ãŸ`);
  }

  console.log('ğŸ‰ å…¨åœ°åŸŸã®ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ');
}

migrateRegions();
```

#### Step 2: restaurantsãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

```javascript
// migrate-restaurants.js

async function migrateRestaurants() {
  // å…¨ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  const allRestaurants = JSON.parse(
    fs.readFileSync('../â˜…all-restaurants-with-ids.json', 'utf8')
  );

  // åœ°åŸŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  const regions = JSON.parse(
    fs.readFileSync('./data/regions-data-with-elevation.json', 'utf8')
  );

  for (const region of regions) {
    const regionSlug = region.fileName || region.name.replace(/[\/\\:*?"<>|]/g, '_');

    // ã“ã®åœ°åŸŸã®500mä»¥å†…ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’æŠ½å‡º
    const nearbyRestaurants = allRestaurants.restaurants.filter(r => {
      const distance = geolib.getDistance(
        { latitude: region.lat, longitude: region.lng },
        { latitude: r.latitude, longitude: r.longitude }
      );
      return distance <= 500;
    });

    // Supabaseã«æŒ¿å…¥
    for (const restaurant of nearbyRestaurants) {
      await supabase
        .from('restaurants')
        .upsert({
          region_slug: regionSlug,
          name: restaurant.name,
          lat: restaurant.latitude,
          lng: restaurant.longitude,
          score: restaurant.score,
          genre: restaurant.genre,
          address: restaurant.address,
          dinner_budget: restaurant.dinnerBudget,
          likes_count: 0
        });
    }

    console.log(`âœ… ${region.name} ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ ${nearbyRestaurants.length}ä»¶ã‚’ç§»è¡Œã—ã¾ã—ãŸ`);
  }

  console.log('ğŸ‰ å…¨ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ');
}

migrateRestaurants();
```

#### Step 3: parking_spotsãƒ†ãƒ¼ãƒ–ãƒ«ã«region_slugã‚’è¿½åŠ 

```sql
-- æ—¢å­˜ã®parking_spotsãƒ†ãƒ¼ãƒ–ãƒ«ã«region_slugåˆ—ã‚’è¿½åŠ 
ALTER TABLE parking_spots ADD COLUMN IF NOT EXISTS region_slug TEXT;
ALTER TABLE parking_spots ADD COLUMN IF NOT EXISTS likes_count INTEGER DEFAULT 0;

-- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦region_slugã‚’è¨­å®šï¼ˆæœ€ã‚‚è¿‘ã„åœ°åŸŸã‚’å‰²ã‚Šå½“ã¦ï¼‰
-- ã“ã‚Œã¯Supabaseé–¢æ•°ã¨ã—ã¦å®Ÿè£…
CREATE OR REPLACE FUNCTION assign_region_to_parking_spots()
RETURNS void AS $$
DECLARE
  parking RECORD;
  nearest_region RECORD;
BEGIN
  FOR parking IN SELECT * FROM parking_spots WHERE region_slug IS NULL LOOP
    -- æœ€ã‚‚è¿‘ã„åœ°åŸŸã‚’æ¤œç´¢
    SELECT slug INTO nearest_region
    FROM regions
    ORDER BY ST_Distance(
      ST_MakePoint(lng, lat)::geography,
      ST_MakePoint(parking.lng, parking.lat)::geography
    ) ASC
    LIMIT 1;

    -- region_slugã‚’æ›´æ–°
    UPDATE parking_spots
    SET region_slug = nearest_region.slug
    WHERE id = parking.id;
  END LOOP;
END;
$$ LANGUAGE plpgsql;

-- å®Ÿè¡Œ
SELECT assign_region_to_parking_spots();
```

---

## 7. å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ï¼ˆ1é€±é–“ï¼‰
- âœ… Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
- âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆprofiles, regions, parking_spots, restaurants, likes, commentsï¼‰
- âœ… RLSè¨­å®š
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°ä½œæˆ
- âœ… ãƒˆãƒªã‚¬ãƒ¼è¨­å®š

### Phase 2: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼ˆ1é€±é–“ï¼‰
- âœ… regions ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆ808ç®‡æ‰€ï¼‰
- âœ… parking_spots ãƒ†ãƒ¼ãƒ–ãƒ«ã« region_slug è¿½åŠ 
- âœ… restaurants ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
- âœ… ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼

### Phase 3: èªè¨¼æ©Ÿèƒ½ï¼ˆ2é€±é–“ï¼‰
- âœ… Supabase Authè¨­å®š
- âœ… Google OAuthè¨­å®š
- âœ… ä¼šå“¡ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³UI
- âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸

### Phase 4: ã„ã„ã­æ©Ÿèƒ½ï¼ˆ2é€±é–“ï¼‰
- âœ… åœ°åŸŸãƒšãƒ¼ã‚¸ã«ã„ã„ã­ãƒœã‚¿ãƒ³è¿½åŠ 
- âœ… é§è»Šå ´ã‚«ãƒ¼ãƒ‰ã«ã„ã„ã­ãƒœã‚¿ãƒ³è¿½åŠ 
- âœ… ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰ã«ã„ã„ã­ãƒœã‚¿ãƒ³è¿½åŠ 
- âœ… ã„ã„ã­æ•°ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
- âœ… ãƒã‚¤ãƒšãƒ¼ã‚¸ã«ã„ã„ã­å±¥æ­´è¡¨ç¤º

### Phase 5: ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ï¼ˆ2é€±é–“ï¼‰
- âœ… åœ°åŸŸãƒšãƒ¼ã‚¸ã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ è¿½åŠ ï¼ˆä¼šå“¡ã®ã¿ï¼‰
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºãƒ»ç·¨é›†ãƒ»å‰Šé™¤
- âœ… è¿”ä¿¡æ©Ÿèƒ½
- âœ… ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½

### Phase 6: ãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–ï¼ˆ1é€±é–“ï¼‰
- âœ… æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼
- âœ… ãƒ‡ãƒ—ãƒ­ã‚¤

---

## 8. ã¾ã¨ã‚

### âœ… å®Ÿç¾ã™ã‚‹æ©Ÿèƒ½

| å¯¾è±¡ | ã„ã„ã­ | ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ | é–²è¦§ |
|------|--------|-------------|------|
| **åœ°åŸŸãƒšãƒ¼ã‚¸** | èª°ã§ã‚‚ | ä¼šå“¡ã®ã¿ | èª°ã§ã‚‚ |
| **é§è»Šå ´ã‚«ãƒ¼ãƒ‰** | èª°ã§ã‚‚ | âŒ | èª°ã§ã‚‚ |
| **ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰** | èª°ã§ã‚‚ | âŒ | èª°ã§ã‚‚ |

### ğŸ“Š ãƒ‡ãƒ¼ã‚¿è¦æ¨¡

- **åœ°åŸŸ**: 808ç®‡æ‰€
- **é§è»Šå ´**: æ•°åƒç®‡æ‰€ï¼ˆSupabaseæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼‰
- **ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³**: 18,345ä»¶ï¼ˆâ˜…all-restaurants-with-ids.jsonã‹ã‚‰æŠ½å‡ºï¼‰
- **äºˆæƒ³ä¼šå“¡æ•°**: åˆæœŸ500äºº/æœˆã€1å¹´å¾Œ5,000äºº

### ğŸ’° ã‚³ã‚¹ãƒˆ

**Supabase Free Tier ã§é‹ç”¨å¯èƒ½**
- æœˆé–“1ä¸‡è¨ªå•è€…ã¾ã§
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹500MB
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸1GB
- èªè¨¼50,000 MAU

### ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®Ÿè£…
3. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ
4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
5. ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤

ã“ã®è¦ä»¶å®šç¾©ã§å•é¡Œãªã„ã‹ã”ç¢ºèªãã ã•ã„ï¼
